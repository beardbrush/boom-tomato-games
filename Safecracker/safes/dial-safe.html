<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<link rel="manifest" href="../manifest.json">

<meta name="theme-color" content="#0b0704">

<title>SAFECRACKER — BRONZE DIAL</title>
<style>
  :root{
    --bg0:#0b0704;
    --bg1:#15100a;

    --brass:#caa35a;
    --ink:#f3e7cf;
    --dim:rgba(243,231,207,.70);

    --line:rgba(202,163,90,.28);
    --line2:rgba(202,163,90,.14);

    --good:rgba(160,255,210,.85);
    --bad:rgba(255,120,140,.85);
    --warn:rgba(255,210,120,.85);

    --shadow: 0 14px 40px rgba(0,0,0,.55);
    --radius: 14px;

    --pad: 12px;
    --gap: 12px;
    --topH: 58px;
    --botH: 48px;

    --dialSize: 360px;
  }

  *{box-sizing:border-box;}
  html,body{
touch-action: manipulation;
  overscroll-behavior: none;
    height:100%;
    margin:0;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    color:var(--ink);
    background:
      radial-gradient(900px 500px at 25% 20%, rgba(202,163,90,.08), transparent 60%),
      radial-gradient(700px 500px at 80% 70%, rgba(255,180,90,.05), transparent 55%),
      linear-gradient(180deg,var(--bg0),var(--bg1));
    overflow:hidden;
    transition: filter .6s ease;
  }
  *::-webkit-scrollbar{width:0;height:0;}
  *{scrollbar-width:none;}

  .grain,.vignette{pointer-events:none; position:fixed; inset:0; z-index:50;}
  .grain{
    opacity:.10;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.6'/%3E%3C/svg%3E");
    background-size:220px 220px;
    mix-blend-mode:soft-light;
    animation: drift 1.6s steps(2,end) infinite;
  }
  @keyframes drift{
    0%{transform:translate(0,0);}
    25%{transform:translate(-2px,1px);}
    50%{transform:translate(2px,-1px);}
    75%{transform:translate(-1px,-2px);}
    100%{transform:translate(0,0);}
  }
  .vignette{
    background: radial-gradient(circle at 50% 42%, rgba(0,0,0,0) 35%, rgba(0,0,0,.65) 100%);
    opacity:.85;
    transition: opacity .6s ease;
  }

  body.urgent{ filter: saturate(1.05) contrast(1.05); }
  body.danger{ filter: saturate(1.10) contrast(1.10); }
  body.urgent .vignette{ opacity:.92; }
  body.danger .vignette{ opacity:.97; }

  .wrap{
    height:100%;
    display:grid;
    grid-template-rows: var(--topH) 1fr var(--botH);
    gap:var(--gap);
    padding:var(--pad);
  }
.safeWrap{
  max-width: 92vmin;
  max-height: 92vmin;
  aspect-ratio: 1 / 1;
  margin: auto;
}


  .bar{
    background: linear-gradient(180deg, rgba(30,20,12,.75), rgba(10,7,4,.55));
    border:1px solid var(--line2);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    position:relative;
    overflow:hidden;
  }
  .bar::before{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(90deg, transparent, rgba(202,163,90,.12), transparent);
    transform:translateX(-70%);
    animation:sheen 7.2s linear infinite;
    opacity:.55;
  }
  @keyframes sheen{to{transform:translateX(170%);}}
  .bar .row{
    position:relative;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    gap:12px;
    min-width:0;
  }

  .pill{
    border:1px solid var(--line2);
    border-radius:999px;
    padding:6px 10px;
    background: rgba(0,0,0,.18);
    letter-spacing:.14em;
    text-transform:uppercase;
    color:var(--dim);
    white-space:nowrap;
  }
  .pill b{color:var(--ink); letter-spacing:.18em;}
  .pill.hot{
    border-color: rgba(255,210,120,.28);
    color: rgba(255,235,190,.92);
    box-shadow: 0 0 18px rgba(255,210,120,.08);
  }
  .pill.danger{
    border-color: rgba(255,120,140,.28);
    color: rgba(255,200,210,.92);
    box-shadow: 0 0 18px rgba(255,120,140,.08);
  }

  .right{margin-left:auto; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
  .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center; min-width:0;}

  .main{
    height:100%;
    min-height:0;
    display:grid;
    grid-template-columns: 360px 1fr 360px;
    gap:var(--gap);
  }

  .panel{
    background:
      radial-gradient(800px 500px at 50% 0%, rgba(202,163,90,.07), transparent 60%),
      linear-gradient(180deg, rgba(25,18,12,.70), rgba(12,8,5,.55));
    border:1px solid var(--line2);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    position:relative;
    overflow:hidden;
    min-height:0;
  }
  .panel::after{
    content:"";
    position:absolute; inset:0;
    background:
      linear-gradient(var(--line),var(--line)) left 12px top 12px/18px 1px no-repeat,
      linear-gradient(var(--line),var(--line)) left 12px top 12px/1px 18px no-repeat,
      linear-gradient(var(--line),var(--line)) right 12px top 12px/18px 1px no-repeat,
      linear-gradient(var(--line),var(--line)) right 12px top 12px/1px 18px no-repeat,
      linear-gradient(var(--line),var(--line)) left 12px bottom 12px/18px 1px no-repeat,
      linear-gradient(var(--line),var(--line)) left 12px bottom 12px/1px 18px no-repeat,
      linear-gradient(var(--line),var(--line)) right 12px bottom 12px/18px 1px no-repeat,
      linear-gradient(var(--line),var(--line)) right 12px bottom 12px/1px 18px no-repeat;
    opacity:.65;
    pointer-events:none;
  }

  .hdr{
    padding:10px 12px 8px;
    border-bottom:1px dashed var(--line2);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .hdr .title{
    font-size:12px;
    letter-spacing:.22em;
    text-transform:uppercase;
    color:var(--ink);
    white-space:nowrap;
  }
  .hdr .chip{
    font-size:11px;
    letter-spacing:.18em;
    text-transform:uppercase;
    color:var(--dim);
    border:1px solid var(--line2);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:3px 8px;
    white-space:nowrap;
  }
  .body{
    padding:12px;
    height: calc(100% - 44px);
    min-height:0;
    position:relative;
  }

  /* LEFT: controls */
  .controls{
    display:grid;
    grid-template-rows: 1fr auto;
    gap:12px;
    height:100%;
    min-height:0;
  }
  .btnGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: repeat(3, 1fr);
    gap:10px;
    height:100%;
    min-height:0;
  }
  .btn{
    border-radius:14px;
    border:1px solid rgba(202,163,90,.26);
    background:
      radial-gradient(circle at 30% 25%, rgba(202,163,90,.10), rgba(0,0,0,.26));
    color:var(--ink);
    letter-spacing:.22em;
    text-transform:uppercase;
    font-weight:700;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px 12px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
    min-height:58px;
    user-select:none;
    transition: transform 80ms ease;
  }
  .btn:active{ transform: translateY(1px); }
  .btn .tag2{
    font-size:10px;
    color:var(--dim);
    letter-spacing:.18em;
    font-weight:600;
  }
  .btn.disabled{
    opacity:.45;
    cursor:not-allowed;
    filter:saturate(.7);
  }

  .meter{
    border:1px solid rgba(202,163,90,.18);
    border-radius:14px;
    background: rgba(0,0,0,.18);
    padding:10px;
  }
  .meterRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    letter-spacing:.18em;
    text-transform:uppercase;
    font-size:11px;
    color:var(--dim);
    margin-bottom:8px;
  }
  .barline{
    height:8px;
    border-radius:999px;
    background: rgba(202,163,90,.10);
    border:1px solid rgba(202,163,90,.14);
    overflow:hidden;
  }
  .barfill{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(160,255,210,.65), rgba(255,210,120,.55), rgba(255,120,140,.55));
    box-shadow: 0 0 18px rgba(202,163,90,.10);
  }

  /* CENTER: safe */
  .safeStage{
    height:100%;
    display:grid;
    grid-template-rows: auto 1fr auto;
    gap:12px;
  }

  .comboBox{
    border:1px solid rgba(202,163,90,.18);
    border-radius:14px;
    background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.14));
    padding:10px;
    letter-spacing:.18em;
    text-transform:uppercase;
    font-size:11px;
    color:var(--dim);
    overflow:hidden;
  }
  .comboBox b{color:var(--ink); letter-spacing:.22em;}
  .comboLine{
    margin-top:6px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .codeChip{
    border:1px solid rgba(202,163,90,.20);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:6px 10px;
    font-size:11px;
    color:var(--ink);
    letter-spacing:.22em;
  }
  .codeChip.done{
    border-color: rgba(160,255,210,.28);
    color: rgba(210,255,235,.95);
    box-shadow: 0 0 16px rgba(160,255,210,.10);
  }

  /* ===== Safe Face (bronze) ===== */
  .safeFace{
    position:relative;
    border-radius: 18px;
    border:1px solid rgba(202,163,90,.20);
    background:
      radial-gradient(800px 380px at 50% 0%, rgba(202,163,90,.12), transparent 60%),
      radial-gradient(900px 600px at 30% 35%, rgba(255,230,170,.05), transparent 60%),
      radial-gradient(700px 520px at 75% 70%, rgba(0,0,0,.35), transparent 65%),
      linear-gradient(180deg, rgba(35,25,15,.78), rgba(10,7,4,.55));
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.20),
      inset 0 0 60px rgba(0,0,0,.22);
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:0;

    transform-origin: left center;
    transform: perspective(900px) rotateY(0deg);
    transition: transform 1.05s cubic-bezier(.18,.85,.28,1),
                box-shadow 1.05s ease;
  }
  .safeFace.open{
    transform: perspective(900px) rotateY(-12deg);
    box-shadow:
      inset -40px 0 80px rgba(0,0,0,.55),
      0 30px 80px rgba(0,0,0,.75);
  }

  .safeFace::before{
    content:"";
    position:absolute; inset:18px;
    border-radius:16px;
    border:1px solid rgba(202,163,90,.12);
    box-shadow:
      inset 0 0 0 2px rgba(0,0,0,.22),
      inset 0 0 0 1px rgba(255,230,170,.03);
    background:
      radial-gradient(600px 420px at 50% 10%, rgba(255,230,170,.06), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.22));
    opacity:.95;
    pointer-events:none;
  }

  .safeFace::after{
    content:"";
    position:absolute; inset:0;
    background: radial-gradient(circle at 60% 50%, rgba(255,215,140,.35), transparent 60%);
    opacity:0;
    transition: opacity 1s ease;
    pointer-events:none;
  }
  .safeFace.open::after{ opacity:1; }

  .boltChannel{
    position:absolute;
    right:18px;
    top:32px;
    bottom:32px;
    width:18px;
    border-radius:12px;
    border:1px solid rgba(202,163,90,.16);
    background:
      linear-gradient(180deg, rgba(0,0,0,.35), rgba(255,230,170,.04), rgba(0,0,0,.35));
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    opacity:.70;
    pointer-events:none;
  }

  .hinge{
    position:absolute;
    left:14px;
    width:44px;
    height:86px;
    border-radius:14px;
    border:1px solid rgba(202,163,90,.18);
    background:
      radial-gradient(circle at 30% 30%, rgba(255,230,170,.10), rgba(0,0,0,.30));
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.22);
    opacity:.78;
    pointer-events:none;
  }
  .hinge.h1{ top:42px; }
  .hinge.h2{ top:50%; transform: translateY(-50%); }
  .hinge.h3{ bottom:42px; }

  .handle{
    position:absolute;
    right:52px;
    top:50%;
    transform: translateY(-50%);
    width:84px;
    height:28px;
    border-radius:999px;
    border:1px solid rgba(202,163,90,.28);
    background:
      radial-gradient(circle at 30% 30%, rgba(255,230,170,.22), rgba(0,0,0,.28));
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.18),
      0 8px 18px rgba(0,0,0,.35);
    opacity:.88;
    pointer-events:none;
  }
  .handle::after{
    content:"";
    position:absolute;
    left:50%; top:50%;
    transform: translate(-50%,-50%);
    width:14px; height:14px;
    border-radius:50%;
    border:1px solid rgba(255,230,170,.18);
    background: rgba(0,0,0,.20);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.20);
  }

  .plaque{
    position:absolute;
    left:26px;
    bottom:26px;
    width: 220px;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid rgba(202,163,90,.28);
    background:
      linear-gradient(180deg, rgba(202,163,90,.16), rgba(0,0,0,.22));
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.18),
      0 10px 18px rgba(0,0,0,.30);
    letter-spacing:.18em;
    text-transform:uppercase;
    font-size:10px;
    color: rgba(255,235,190,.88);
    opacity:.82;
    pointer-events:none;
  }
  .plaque b{ color: rgba(255,245,220,.92); letter-spacing:.22em; }

  .wear{
    position:absolute; inset:0;
    background:
      repeating-linear-gradient( 18deg,
        rgba(255,230,170,.03) 0px,
        rgba(255,230,170,.03) 1px,
        rgba(0,0,0,0) 10px,
        rgba(0,0,0,0) 16px
      ),
      radial-gradient(900px 600px at 45% 60%, rgba(0,0,0,.18), transparent 60%);
    mix-blend-mode: overlay;
    opacity:.20;
    pointer-events:none;
  }

  .rivet{
    position:absolute;
    width:10px;height:10px;border-radius:50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,230,170,.55), rgba(0,0,0,.35));
    border:1px solid rgba(202,163,90,.22);
    opacity:.85;
    pointer-events:none;
  }
  .rivet.tl{left:14px; top:14px;}
  .rivet.tr{right:14px; top:14px;}
  .rivet.bl{left:14px; bottom:14px;}
  .rivet.br{right:14px; bottom:14px;}

  /* Dial */
  .dialWrap{
    width: min(var(--dialSize), 92%);
    aspect-ratio:1/1;
    position:relative;
    filter: drop-shadow(0 18px 40px rgba(0,0,0,.55));
    z-index:2;
  }

  .dial{
    position:absolute; inset:0;
    border-radius:50%;
    background:
      radial-gradient(circle at 50% 45%, rgba(255,230,170,.18), transparent 55%),
      radial-gradient(circle at 50% 50%, rgba(202,163,90,.18), rgba(0,0,0,.22)),
      conic-gradient(from 0deg,
        rgba(202,163,90,.25),
        rgba(202,163,90,.08),
        rgba(202,163,90,.25));
    border:1px solid rgba(202,163,90,.30);
    box-shadow:
      inset 0 0 0 10px rgba(0,0,0,.16),
      inset 0 0 0 1px rgba(255,230,170,.06);
    transform: rotate(0deg);
    transition: transform 80ms linear;
    overflow:hidden;
  }
  .dial.sticky{ transition: transform 140ms ease; }

  .ticks{
    position:absolute; inset:10%;
    border-radius:50%;
    background:
      repeating-conic-gradient(
        from -90deg,
        rgba(243,231,207,.35) 0deg,
        rgba(243,231,207,.35) 1deg,
        rgba(0,0,0,0) 1deg,
        rgba(0,0,0,0) 6deg
      );
    mask: radial-gradient(circle, transparent 60%, #000 61%);
    opacity:.55;
  }
  .ticks2{
    position:absolute; inset:18%;
    border-radius:50%;
    background:
      repeating-conic-gradient(
        from -90deg,
        rgba(243,231,207,.22) 0deg,
        rgba(243,231,207,.22) 1deg,
        rgba(0,0,0,0) 1deg,
        rgba(0,0,0,0) 12deg
      );
    mask: radial-gradient(circle, transparent 64%, #000 65%);
    opacity:.45;
  }

  .hub{
    position:absolute;
    left:50%; top:50%;
    transform: translate(-50%,-50%);
    width:26%;
    aspect-ratio:1/1;
    border-radius:50%;
    background:
      radial-gradient(circle at 35% 30%, rgba(255,230,170,.35), rgba(0,0,0,.30));
    border:1px solid rgba(202,163,90,.30);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.20);
  }

  .needle{
    position:absolute;
    left:50%; top:-10px;
    transform: translateX(-50%);
    width:0;height:0;
    border-left:11px solid transparent;
    border-right:11px solid transparent;
    border-bottom:22px solid rgba(255,230,170,.65);
    filter: drop-shadow(0 6px 10px rgba(0,0,0,.45));
    opacity:.85;
    z-index:3;
  }

  .window{
    position:absolute;
    top:12px; left:50%;
    transform: translateX(-50%);
    width: 190px;
    padding:8px 10px;
    border-radius: 12px;
    border:1px solid rgba(202,163,90,.30);
    background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.30));
    box-shadow: inset 0 0 0 1px rgba(255,230,170,.06);
    text-align:center;
    letter-spacing:.28em;
    text-transform:uppercase;
    z-index:4;
  }
  .window .num{
    font-size:22px;
    color:var(--ink);
    text-shadow: 0 0 18px rgba(202,163,90,.10);
    font-weight:800;
  }
  .window .sub{
    margin-top:2px;
    font-size:10px;
    color:var(--dim);
    letter-spacing:.18em;
  }

  .prompt{
    position:absolute;
    bottom:14px; left:50%;
    transform: translateX(-50%);
    width: min(560px, 92%);
    padding:10px 12px;
    border-radius: 14px;
    border:1px solid rgba(202,163,90,.18);
    background: rgba(0,0,0,.26);
    box-shadow: 0 0 22px rgba(202,163,90,.08);
    text-align:center;
    letter-spacing:.18em;
    text-transform:uppercase;
    color:var(--dim);
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
    z-index:4;
  }
  .prompt.good{ border-color: rgba(160,255,210,.22); color: rgba(210,255,235,.95); }
  .prompt.bad{ border-color: rgba(255,120,140,.22); color: rgba(255,200,210,.95); }
  .prompt.warn{ border-color: rgba(255,210,120,.22); color: rgba(255,235,190,.95); }

  .progress{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    border:1px solid rgba(202,163,90,.18);
    border-radius:14px;
    background: rgba(0,0,0,.18);
    padding:10px 12px;
  }
  .dots{
    display:flex; gap:8px; align-items:center;
  }
  .dot{
    width:12px;height:12px;border-radius:50%;
    border:1px solid rgba(202,163,90,.28);
    background: rgba(202,163,90,.08);
    box-shadow: 0 0 14px rgba(202,163,90,.06);
  }
  .dot.on{
    border-color: rgba(160,255,210,.35);
    background: rgba(160,255,210,.28);
    box-shadow: 0 0 18px rgba(160,255,210,.12);
  }
  .progText{
    font-size:11px;
    letter-spacing:.18em;
    text-transform:uppercase;
    color:var(--dim);
    white-space:nowrap;
  }
  .progText b{color:var(--ink); letter-spacing:.22em;}

  /* RIGHT: notes */
  .stack{
    height:100%;
    display:grid;
    grid-template-rows: 1fr auto;
    gap:12px;
  }
  .noteBox{
    border:1px solid rgba(202,163,90,.18);
    border-radius:14px;
    background: rgba(0,0,0,.18);
    padding:10px 12px;
    line-height:1.35;
    letter-spacing:.06em;
    color:rgba(243,231,207,.78);
    white-space:pre-wrap;
    overflow:hidden;
  }
  .hintBox{
    border:1px solid rgba(202,163,90,.18);
    border-radius:14px;
    background: rgba(0,0,0,.18);
    padding:10px 12px;
    letter-spacing:.16em;
    text-transform:uppercase;
    font-size:11px;
    color:var(--dim);
  }
  .hintBox b{color:var(--ink); letter-spacing:.22em;}

  /* Bottom keys */
  .keys{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    font-size:11px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:var(--dim);
  }
  .key{
    border:1px solid rgba(202,163,90,.16);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:6px 10px;
    user-select:none;
  }
  .key b{color:var(--ink); letter-spacing:.18em;}

  .shake{ animation: shake .18s linear; }
  @keyframes shake{
    0%{transform:translate(0,0);}
    25%{transform:translate(-2px,1px);}
    50%{transform:translate(2px,-1px);}
    75%{transform:translate(-1px,-2px);}
    100%{transform:translate(0,0);}
  }

  @media (max-width: 1100px){
    :root{ --dialSize: 320px; }
    .main{ grid-template-columns: 320px 1fr 320px; }
  }
  @media (max-width: 980px){
    .main{ grid-template-columns: 1fr; grid-template-rows: 280px 1fr 300px; }
  }
  @media (max-width: 480px){
  :root{
    --botH: 64px;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="row">
        <div class="left">
          <span class="pill">Safe: <b id="safeName">Bronze Dial</b></span>
          <span class="pill">Lock: <b id="lockType">6-Tumbler</b></span>
          <span class="pill">Cracks: <b id="cracks">000</b></span>
          <span class="pill">Jams: <b id="jams">000</b></span>
        </div>
        <div class="right">
          <span class="pill">Mode: <b id="modeLabel">Casual</b></span>
          <span class="pill" id="timerPill">Window: <b id="timer">00:30</b></span>
          <span class="pill">Press <b>B</b> Bench • <b>F</b> Fullscreen</span>
        </div>
      </div>
    </div>

    <div class="main">
      <!-- LEFT -->
      <div class="panel">
        <div class="hdr">
          <div class="title">Hand Controls</div>
          <div class="chip">Input</div>
        </div>
        <div class="body controls">
          <div class="btnGrid">
            <button class="btn" id="btnLeft"><span>Left</span><span class="tag2">−1</span></button>
            <button class="btn" id="btnRight"><span>Right</span><span class="tag2">+1</span></button>
            <button class="btn" id="btnSpinL"><span>Spin ◀</span><span class="tag2">−5</span></button>
            <button class="btn" id="btnSpinR"><span>Spin ▶</span><span class="tag2">+5</span></button>
            <button class="btn" id="btnCrack"><span>Crack</span><span class="tag2">Commit</span></button>
            <button class="btn disabled" id="btnOpen"><span>Open</span><span class="tag2">Latch</span></button>
          </div>

          <div class="meter">
            <div class="meterRow">
              <span>Noise</span>
              <span><b id="noiseTxt">0%</b></span>
            </div>
            <div class="barline"><div class="barfill" id="noiseFill"></div></div>
            <div style="margin-top:10px; font-size:11px; color:var(--dim); letter-spacing:.08em; line-height:1.35;">
              In Endurance, noise is pressure — but clicks remain sound-only.
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER -->
      <div class="panel">
        <div class="hdr">
          <div class="title">Tumbler Window</div>
          <div class="chip">Sound Only</div>
        </div>
        <div class="body safeStage">
          <div class="comboBox">
            <div><b id="comboHdr">Combination</b> <span id="comboSub">• visible in casual</span></div>
            <div class="comboLine" id="comboLine"></div>
          </div>

          <div class="safeFace" id="safeFace">
            <div class="wear" aria-hidden="true"></div>
            <span class="rivet tl"></span><span class="rivet tr"></span><span class="rivet bl"></span><span class="rivet br"></span>
            <div class="hinge h1" aria-hidden="true"></div>
            <div class="hinge h2" aria-hidden="true"></div>
            <div class="hinge h3" aria-hidden="true"></div>
            <div class="boltChannel" aria-hidden="true"></div>
            <div class="handle" aria-hidden="true"></div>
            <div class="plaque" aria-hidden="true"><b>Rattlesnake</b> • Co. • 1889</div>

            <div class="dialWrap" aria-label="Safe dial">
              <div class="needle"></div>

              <div class="window" id="numWindow">
                <div class="num" id="numRead">00</div>
                <div class="sub">dial 0–59</div>
              </div>

              <div class="dial" id="dial">
                <div class="ticks"></div>
                <div class="ticks2"></div>
                <div class="hub"></div>
              </div>
            </div>

            <div class="prompt" id="prompt">BRONZE DIAL SAFE • LISTEN FOR CLICKS</div>
          </div>

          <div class="progress">
            <div class="dots" id="dots"></div>
            <div class="progText">Progress: <b id="prog">0/6</b> • Slip: <b id="slip">0</b>/2</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="hdr">
          <div class="title">Notes</div>
          <div class="chip">Quiet Hands</div>
        </div>
        <div class="body stack">
          <div class="noteBox" id="notes"></div>

          <div class="hintBox">
            <div><b>Endurance</b></div>
            <div style="margin-top:8px; line-height:1.4;">
              • window resets after every correct <b>CRACK</b><br/>
              • window shrinks down to a minimum<br/>
              • no visual click prompts — <b>sound only</b><br/>
              • press <b>OPEN</b> after all tumblers set
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="bar">
      <div class="row">
        <div class="keys">
          <span class="key"><b>←</b> Left</span>
          <span class="key"><b>→</b> Right</span>
          <span class="key"><b>A</b> Spin ◀</span>
          <span class="key"><b>D</b> Spin ▶</span>
          <span class="key"><b>C</b> Crack</span>
          <span class="key"><b>O</b> Open</span>
          <span class="key"><b>B</b> Bench</span>
        </div>
        <div class="keys">
          <span class="key">Status: <b id="status">Steady</b></span>
        </div>
      </div>
    </div>
  </div>

  <div class="grain"></div>
  <div class="vignette"></div>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const pad2 = (n) => String(n).padStart(2,"0");
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const wrap60 = (n) => ((n % 60) + 60) % 60;
  const rand = (a,b) => a + Math.random()*(b-a);
  const randi = (a,b) => Math.floor(rand(a,b+1));

  // Storage keys (same as your hub)
  const K = {
    money: "sc_money",
    cracks: "sc_totalCracks",
    jams: "sc_totalJams",
    bestRun: "sc_bestRun",
    recent: "sc_recent",
    run: "sc_run_current",
    mode: "sc_mode" // ✅ added
  };
  function getNum(key, def=0){
    const v = localStorage.getItem(key);
    const n = Number(v);
    return Number.isFinite(n) ? n : def;
  }
  function setNum(key, val){
    localStorage.setItem(key, String(Math.max(0, Math.floor(val))));
  }
  function getJSON(key, def){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return def;
      return JSON.parse(raw);
    }catch(e){ return def; }
  }
  function setJSON(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }
  function pushRecent(line){
    const recent = getJSON(K.recent, []);
    const out = [String(line), ...recent].slice(0, 10);
    setJSON(K.recent, out);
  }

  // Query
  const url = new URL(location.href);
  const Q = url.searchParams;

  // ✅ LAUNCH MODE FIX:
  // 1) query param mode
  // 2) localStorage sc_mode (hub)
  // 3) fallback casual
  const MODE = (Q.get("mode") || localStorage.getItem(K.mode) || "casual").toLowerCase();
  const isEndurance = MODE === "endurance";

  // persist if opened directly (keeps hub + safes consistent)
  try{ localStorage.setItem(K.mode, isEndurance ? "endurance" : "casual"); }catch(e){}

  const runId = Q.get("runId") || "";
  const cfgStart = Number(Q.get("start") || 30);
  const cfgDec = Number(Q.get("dec") || 2);
  const cfgMin = Number(Q.get("min") || 10);
  const firstWindow = Number(Q.get("window") || cfgStart);
  const reward = Number(Q.get("reward") || 10);

  function calcWindow(tumblersSet){
    return Math.max(cfgMin, cfgStart - (tumblersSet * cfgDec));
  }

  // Audio
  let ac = null;
  function armAudio(){
    if(ac) return;
    try{ ac = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){}
  }
  function tone(freq=220, dur=0.05, type="sine", gain=0.06){
    if(!ac) return;
    const t = ac.currentTime;
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(gain, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.connect(g); g.connect(ac.destination);
    o.start(t); o.stop(t+dur+0.02);
  }
  const clickSoft = () => tone(520, 0.055, "triangle", 0.055);
  const clunk     = () => { tone(120, 0.09, "square", 0.08); tone(90, 0.11, "sine", 0.05); };
  const scrape    = () => tone(260, 0.03, "sawtooth", 0.032);
  const failBuzz  = () => tone(70,  0.15, "square", 0.08);
  const thudFoot  = (vol=0.055) => {
    if(!ac) return;
    const t = ac.currentTime;
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = "triangle";
    o.frequency.value = 88;
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(vol,t+.02);
    g.gain.exponentialRampToValueAtTime(0.0001,t+.18);
    o.connect(g); g.connect(ac.destination);
    o.start(t); o.stop(t+.22);
  };

  // State
  const state = {
    number: 0,
    combo: [],
    step: 0,
    slips: 0,
    noise: 0,
    spinning: false,

    timeLimit: firstWindow,
    timeLeft: firstWindow,
    timeExpired: false,

    footstepTimer: null,
    lockoutUntil: 0
  };

  // Elements
  const dialEl = $("#dial");
  const numRead = $("#numRead");
  const prompt = $("#prompt");
  const dotsEl = $("#dots");
  const progEl = $("#prog");
  const slipEl = $("#slip");
  const comboLine = $("#comboLine");
  const comboHdr = $("#comboHdr");
  const comboSub = $("#comboSub");
  const notes = $("#notes");
  const safeFace = $("#safeFace");

  const btnLeft = $("#btnLeft");
  const btnRight = $("#btnRight");
  const btnSpinL = $("#btnSpinL");
  const btnSpinR = $("#btnSpinR");
  const btnCrack = $("#btnCrack");
  const btnOpen = $("#btnOpen");

  const noiseFill = $("#noiseFill");
  const noiseTxt = $("#noiseTxt");

  const timerEl = $("#timer");
  const timerPill = $("#timerPill");

  function fmtTime(sec){
    const s = Math.max(0, Math.ceil(sec));
    const m = Math.floor(s/60);
    const r = s % 60;
    return `${pad2(m)}:${pad2(r)}`;
  }
  function updateTimerUI(){
    // hide the timer UI in casual if you want, but leaving it as-is is fine:
    timerEl.textContent = fmtTime(state.timeLeft);
    timerPill.classList.remove("hot","danger");
    const pct = state.timeLimit > 0 ? (state.timeLeft / state.timeLimit) : 0;
    if(pct <= 0.25) timerPill.classList.add("danger");
    else if(pct <= 0.45) timerPill.classList.add("hot");
  }
  function updateFootsteps(){
    if(!isEndurance) return;
    const pct = state.timeLimit > 0 ? (state.timeLeft / state.timeLimit) : 1;
    document.body.classList.remove("urgent","danger");
    const clearFeet = () => {
      if(state.footstepTimer){
        clearInterval(state.footstepTimer);
        state.footstepTimer = null;
      }
    };
    if(pct < 0.50 && pct > 0.25){
      document.body.classList.add("urgent");
      if(!state.footstepTimer){
        state.footstepTimer = setInterval(()=> thudFoot(0.045), 1180);
      }
    } else if(pct <= 0.25){
      document.body.classList.add("danger");
      clearFeet();
      state.footstepTimer = setInterval(()=> thudFoot(0.070), 700);
    } else {
      clearFeet();
    }
  }
  function stopFootsteps(){
    document.body.classList.remove("urgent","danger");
    if(state.footstepTimer){
      clearInterval(state.footstepTimer);
      state.footstepTimer = null;
    }
  }

  function setNotes(){
    notes.textContent =
`note: bronze dial safe
note: count your turns
note: clicks are sound-only
—
endurance:
• timer resets after correct CRACK
• window shrinks: 30 → 10
• press OPEN when ready`;
  }

  function addNoise(amount){
    state.noise = clamp(state.noise + amount, 0, 100);
    noiseFill.style.width = `${state.noise}%`;
    noiseTxt.textContent = `${Math.round(state.noise)}%`;
  }

  // Combo
  function newCombo(len=6){
    const arr = [];
    let last = -999;
    for(let i=0;i<len;i++){
      let n = randi(0,59);
      if(Math.abs(n-last) <= 1) n = wrap60(n + randi(3,11));
      arr.push(n);
      last = n;
    }
    return arr;
  }

  function buildDots(){
    dotsEl.innerHTML = "";
    for(let i=0;i<6;i++){
      const d = document.createElement("div");
      d.className = "dot" + (i < state.step ? " on" : "");
      dotsEl.appendChild(d);
    }
  }

  function renderCombo(){
    comboLine.innerHTML = "";
    if(!isEndurance){
      comboHdr.textContent = "Combination";
      comboSub.textContent = "• visible in casual";
      state.combo.forEach((n,i)=>{
        const chip = document.createElement("span");
        chip.className = "codeChip" + (i < state.step ? " done" : "");
        chip.textContent = String(n).padStart(2,"0");
        comboLine.appendChild(chip);

        if(i !== state.combo.length-1){
          const a = document.createElement("span");
          a.className = "codeChip";
          a.style.opacity = "0.55";
          a.style.padding = "6px 8px";
          a.textContent = "→";
          comboLine.appendChild(a);
        }
      });
    } else {
      comboHdr.textContent = "Endurance";
      comboSub.textContent = "• combination hidden";
      const chipA = document.createElement("span");
      chipA.className = "codeChip";
      chipA.textContent = `TUMBLER ${state.step+1}/6`;
      comboLine.appendChild(chipA);

      const chipB = document.createElement("span");
      chipB.className = "codeChip";
      chipB.style.opacity = "0.70";
      chipB.textContent = "LISTEN FOR CLICKS";
      comboLine.appendChild(chipB);
    }
  }

  // Tolerance: bronze dial = ±1
  function circularDist(a,b){
    const d = Math.abs(wrap60(a-b));
    return Math.min(d, 60-d);
  }
  function inZone(num, target){
    return circularDist(num, target) <= 1;
  }

  function showPrompt(text, kind){
    prompt.classList.remove("good","bad","warn");
    if(kind) prompt.classList.add(kind);
    prompt.textContent = text;
  }

  function setDialNumber(n, opts={fromInput:false}){
    state.number = wrap60(n);
    numRead.textContent = String(state.number).padStart(2,"0");
    const degPer = 360/60;
    const ang = state.number * degPer;
    dialEl.style.transform = `rotate(${ang}deg)`;
    if(opts.fromInput){
      scrape();
      addNoise(isEndurance ? 0.9 : 0.5);
    }
    updateClickSoundOnly();
  }

  // SOUND ONLY: zone enter = click, no visual callout in endurance.
  let lastIn = false;
  function updateClickSoundOnly(){
    if(state.step >= 6) return;
    const target = state.combo[state.step];
    const inside = inZone(state.number, target);
    if(inside && !lastIn){
      clickSoft();
      if(!isEndurance){
        showPrompt("SOFT CLICK…", "good");
        setTimeout(()=> showPrompt("TUMBLER WINDOW • MATCH THE PATTERN", ""), 650);
      }
    }
    lastIn = inside;
  }

  function setButtonsEnabled(on){
    const all = [btnLeft, btnRight, btnSpinL, btnSpinR, btnCrack];
    all.forEach(b => b.classList.toggle("disabled", !on));
    if(!on) all.forEach(b => b.setAttribute("disabled","disabled"));
    else all.forEach(b => b.removeAttribute("disabled"));

    if(state.step < 6){
      btnOpen.classList.add("disabled");
      btnOpen.setAttribute("disabled","disabled");
    } else {
      btnOpen.classList.remove("disabled");
      btnOpen.removeAttribute("disabled");
    }
  }

  function inputAllowed(){
    return performance.now() >= state.lockoutUntil;
  }

  async function spin(delta){
    if(state.spinning) return;
    if(!inputAllowed()) return;
    armAudio();
    state.spinning = true;
    setButtonsEnabled(false);
    $("#status").textContent = "Spinning";

    const steps = 5;
    const dir = delta > 0 ? 1 : -1;
    for(let i=0;i<steps;i++){
      setDialNumber(state.number + dir, {fromInput:true});
      safeFace.classList.add("shake");
      await new Promise(r => setTimeout(r, 65));
      safeFace.classList.remove("shake");
      await new Promise(r => setTimeout(r, 35));
    }
    clunk();
    await new Promise(r => setTimeout(r, 110));
    $("#status").textContent = "Steady";
    state.spinning = false;
    setButtonsEnabled(true);
  }

  function nudge(delta){
    if(state.spinning) return;
    if(!inputAllowed()) return;
    armAudio();
    setDialNumber(state.number + delta, {fromInput:true});
  }

  function jam(reason="JAM"){
    // lifetime jam
    setNum(K.jams, getNum(K.jams,0) + 1);
    $("#jams").textContent = String(getNum(K.jams,0)).padStart(3,"0");
    showPrompt(reason, "bad");
    failBuzz(); failBuzz();
    $("#status").textContent = "Jammed";
    setButtonsEnabled(false);
    stopFootsteps();

    // Endurance ends run immediately
    if(isEndurance){
      const run = getJSON(K.run, null);
      if(run && run.active && run.runId === runId){
        run.active = false;
        setJSON(K.run, run);
        const best = getNum(K.bestRun,0);
        if(run.safesCracked > best) setNum(K.bestRun, run.safesCracked);
        pushRecent(`Run ended (jam). Safes: ${run.safesCracked}.`);
      }
      setTimeout(()=> location.href = `../endurance.html?reason=jam`, 650);
    } else {
      setTimeout(()=> {
        $("#status").textContent = "Steady";
        setButtonsEnabled(true);
        showPrompt("JAM CLEARED • TRY AGAIN", "warn");
      }, 1400);
    }
  }

  // Endurance timer resets AFTER every correct CRACK
  function resetWindowAfterSuccess(){
    if(!isEndurance) return;
    const run = getJSON(K.run, null);
    if(run && run.active && run.runId === runId){
      const next = calcWindow(run.tumblersSet);
      state.timeLimit = next;
      state.timeLeft = next;
      updateTimerUI();
      updateFootsteps();
    }
  }

  function doCrack(){
    if(state.spinning) return;
    if(!inputAllowed()) return;
    armAudio();

    if(state.step >= 6){
      showPrompt("ALL TUMBLERS SET • PRESS OPEN", "good");
      clunk();
      return;
    }

    const target = state.combo[state.step];
    const ok = inZone(state.number, target);

    if(ok){
      state.step++;
      buildDots();
      progEl.textContent = `${state.step}/6`;
      renderCombo();
      showPrompt(`TUMBLER SET • ${state.step}/6`, "good");
      clunk();
      $("#status").textContent = "Set";
      setTimeout(()=> $("#status").textContent = "Steady", 520);
      lastIn = false;

      if(isEndurance){
        const run = getJSON(K.run, null);
        if(run && run.active && run.runId === runId){
          run.tumblersSet++;
          setJSON(K.run, run);
        }
        resetWindowAfterSuccess();
      }

      if(state.step >= 6){
        btnOpen.classList.remove("disabled");
        btnOpen.removeAttribute("disabled");
        showPrompt("LOCK READY • PRESS OPEN", "good");
      } else {
        setTimeout(()=> showPrompt("BRONZE DIAL SAFE • LISTEN FOR CLICKS", ""), 450);
      }
    } else {
      state.slips++;
      slipEl.textContent = String(state.slips);
      failBuzz();
      safeFace.classList.add("shake");
      setTimeout(()=> safeFace.classList.remove("shake"), 180);
      showPrompt("SLIP • WRONG CRACK", "bad");
      $("#status").textContent = "Slip";
      setTimeout(()=> $("#status").textContent = "Steady", 650);
      addNoise(isEndurance ? 6 : 4);
      if(state.slips >= 2) jam("JAM • PICK SNAPPED");
    }
  }

  function openDoor(){
    safeFace.classList.add("open");
    clunk();
    setTimeout(()=> clunk(), 180);
  }
  function closeDoor(){
    safeFace.classList.remove("open");
  }

  function doOpen(){
    if(state.step < 6 || state.spinning) return;
    if(!inputAllowed()) return;
    armAudio();

    if(isEndurance){
      setNum(K.cracks, getNum(K.cracks,0) + 1);
      setNum(K.money, getNum(K.money,0) + reward);
      $("#cracks").textContent = String(getNum(K.cracks,0)).padStart(3,"0");

      const run = getJSON(K.run, null);
      if(run && run.active && run.runId === runId){
        run.safesCracked++;
        run.moneyEarned += reward;
        setJSON(K.run, run);
      }
      pushRecent(`Cracked bronze dial (+$${reward}).`);
    } else {
      setNum(K.cracks, getNum(K.cracks,0) + 1);
      $("#cracks").textContent = String(getNum(K.cracks,0)).padStart(3,"0");
    }

    showPrompt("SAFE CRACKED • TAKE THE HAUL", "good");
    $("#status").textContent = "Cracked";
    setButtonsEnabled(false);
    btnOpen.classList.add("disabled");
    btnOpen.setAttribute("disabled","disabled");
    openDoor();
    stopFootsteps();

    setTimeout(() => {
      if(isEndurance){
        closeDoor();
        location.href = `../endurance.html?result=cracked`;
      } else {
        showPrompt("PRESS B FOR BENCH • OR NEW SAFE", "warn");
        $("#status").textContent = "Steady";
        setButtonsEnabled(true);
      }
    }, 900);
  }

  // Timer loop: in endurance, timeLeft is the window BETWEEN CRACKS.
  let last = performance.now();
  function loop(now){
    const dt = now - last;
    last = now;

    if(isEndurance && !state.timeExpired){
      const status = $("#status").textContent;
      if(status !== "Jammed" && status !== "Cracked"){
        state.timeLeft -= dt/1000;
        if(state.timeLeft <= 0){
          state.timeLeft = 0;
          state.timeExpired = true;
          updateTimerUI();
          jam("TIME UP • FOOTSTEPS AT THE DOOR");
        } else {
          updateTimerUI();
          updateFootsteps();
        }
      }
    }

    // Noise decay
    const decay = (isEndurance ? 0.010 : 0.016) * dt;
    if(state.noise > 0){
      state.noise = Math.max(0, state.noise - decay);
      noiseFill.style.width = `${state.noise}%`;
      noiseTxt.textContent = `${Math.round(state.noise)}%`;
    }

    requestAnimationFrame(loop);
  }

  function wire(){
    const arm = () => armAudio();
    [btnLeft,btnRight,btnSpinL,btnSpinR,btnCrack,btnOpen].forEach(el => el.addEventListener("pointerdown", arm));

    btnLeft.addEventListener("click", () => nudge(-1));
    btnRight.addEventListener("click", () => nudge(+1));
    btnSpinL.addEventListener("click", () => spin(-5));
    btnSpinR.addEventListener("click", () => spin(+5));
    btnCrack.addEventListener("click", doCrack);
    btnOpen.addEventListener("click", doOpen);

    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if(k === "arrowleft") nudge(-1);
      if(k === "arrowright") nudge(+1);
      if(k === "a") spin(-5);
      if(k === "d") spin(+5);
      if(k === "c") doCrack();
      if(k === "o") doOpen();
      if(k === "b") location.href = "../index.html";
      if(k === "f") toggleFullscreen();
    });
  }

  async function toggleFullscreen(){
    try{
      if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    }catch(e){}
  }

  function init(){
    // mode label
    $("#modeLabel").textContent = isEndurance ? "Endurance" : "Casual";

    // seed totals display
    $("#cracks").textContent = String(getNum(K.cracks,0)).padStart(3,"0");
    $("#jams").textContent = String(getNum(K.jams,0)).padStart(3,"0");

    state.combo = newCombo(6);
    buildDots();
    renderCombo();
    setNotes();

    state.timeLimit = isEndurance ? firstWindow : 0;
    state.timeLeft = isEndurance ? firstWindow : 0;
    updateTimerUI();

    setDialNumber(randi(0,59), {fromInput:false});
    showPrompt(isEndurance ? "BRONZE DIAL SAFE • ENDURANCE WINDOW RUNNING" : "TUMBLER WINDOW • MATCH THE PATTERN", "warn");
    setTimeout(()=> showPrompt("BRONZE DIAL SAFE • LISTEN FOR CLICKS", ""), 900);

    setButtonsEnabled(true);
    btnOpen.classList.add("disabled");
    btnOpen.setAttribute("disabled","disabled");
    wire();
    requestAnimationFrame(loop);

    window.addEventListener("pointerdown", armAudio, { once:true });
  }

  init();
})();
</script>
</body>
</html>


