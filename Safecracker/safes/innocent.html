<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<link rel="manifest" href="../manifest.json">

<meta name="theme-color" content="#0b0704">

<title>SAFECRACKER — INNOCENT LOCK (1872)</title>
<style>
  :root{
    --bg0:#070604;
    --bg1:#0d0b08;

    /* Iron / cast-iron palette */
    --ironA:#d7d2c7;   /* worn highlights */
    --ironB:#a49e92;   /* mid */
    --ironC:#6d665c;   /* dark iron */
    --ironD:#24211c;   /* deep shadow */

    --rustA:#b4642f;   /* subtle rust */
    --rustB:#7a3a18;

    --ink:#f2eee4;
    --dim:rgba(242,238,228,.70);

    --line:rgba(210,200,180,.28);
    --line2:rgba(210,200,180,.14);

    --good:rgba(160,255,210,.85);
    --bad:rgba(255,120,140,.85);
    --warn:rgba(255,210,120,.85);

    --shadow: 0 16px 46px rgba(0,0,0,.62);
    --radius: 14px;

    --pad: 12px;
    --gap: 12px;
    --topH: 58px;
    --botH: 48px;

    --dialSize: 320px;
  }

  *{box-sizing:border-box;}
  html,body{
    touch-action: manipulation;
    overscroll-behavior: none;
    height:100%;
    margin:0;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    color:var(--ink);
    background:
      radial-gradient(900px 520px at 20% 15%, rgba(210,200,180,.07), transparent 60%),
      radial-gradient(800px 600px at 80% 70%, rgba(180,120,80,.05), transparent 55%),
      linear-gradient(180deg,var(--bg0),var(--bg1));
    overflow:hidden;
    transition: filter .6s ease;
  }
  *::-webkit-scrollbar{width:0;height:0;}
  *{scrollbar-width:none;}

  .grain,.vignette{pointer-events:none; position:fixed; inset:0; z-index:50;}
  .grain{
    opacity:.10;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.6'/%3E%3C/svg%3E");
    background-size:220px 220px;
    mix-blend-mode:soft-light;
    animation: drift 1.6s steps(2,end) infinite;
  }
  @keyframes drift{
    0%{transform:translate(0,0);}
    25%{transform:translate(-2px,1px);}
    50%{transform:translate(2px,-1px);}
    75%{transform:translate(-1px,-2px);}
    100%{transform:translate(0,0);}
  }
  .vignette{
    background: radial-gradient(circle at 50% 42%, rgba(0,0,0,0) 35%, rgba(0,0,0,.72) 100%);
    opacity:.88;
    transition: opacity .6s ease;
  }

  body.urgent{ filter: saturate(1.03) contrast(1.05); }
  body.danger{ filter: saturate(1.08) contrast(1.10); }
  body.urgent .vignette{ opacity:.94; }
  body.danger .vignette{ opacity:.98; }

  .wrap{
    height:100%;
    display:grid;
    grid-template-rows: var(--topH) 1fr var(--botH);
    gap:var(--gap);
    padding:var(--pad);
  }
  .safeWrap{
    max-width: 92vmin;
    max-height: 92vmin;
    aspect-ratio: 1 / 1;
    margin: auto;
  }

  .bar{
    background: linear-gradient(180deg, rgba(18,16,12,.76), rgba(8,7,5,.56));
    border:1px solid var(--line2);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    position:relative;
    overflow:hidden;
  }
  .bar::before{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(90deg, transparent, rgba(210,200,180,.12), transparent);
    transform:translateX(-70%);
    animation:sheen 7.2s linear infinite;
    opacity:.55;
  }
  @keyframes sheen{to{transform:translateX(170%);}}
  .bar .row{
    position:relative;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    gap:12px;
    min-width:0;
  }

  .pill{
    border:1px solid var(--line2);
    border-radius:999px;
    padding:6px 10px;
    background: rgba(0,0,0,.18);
    letter-spacing:.14em;
    text-transform:uppercase;
    color:var(--dim);
    white-space:nowrap;
  }
  .pill b{color:var(--ink); letter-spacing:.18em;}
  .pill.hot{
    border-color: rgba(255,210,120,.28);
    color: rgba(255,235,190,.92);
    box-shadow: 0 0 18px rgba(255,210,120,.08);
  }
  .pill.danger{
    border-color: rgba(255,120,140,.28);
    color: rgba(255,200,210,.92);
    box-shadow: 0 0 18px rgba(255,120,140,.08);
  }

  .right{margin-left:auto; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
  .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center; min-width:0;}

  .main{
    height:100%;
    min-height:0;
    display:grid;
    grid-template-columns: 360px 1fr 360px;
    gap:var(--gap);
  }

  .panel{
    background:
      radial-gradient(900px 600px at 50% 0%, rgba(210,200,180,.08), transparent 60%),
      linear-gradient(180deg, rgba(18,16,12,.72), rgba(8,7,5,.56));
    border:1px solid var(--line2);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    position:relative;
    overflow:hidden;
    min-height:0;
  }
  .panel::after{
    content:"";
    position:absolute; inset:0;
    background:
      linear-gradient(var(--line),var(--line)) left 12px top 12px/18px 1px no-repeat,
      linear-gradient(var(--line),var(--line)) left 12px top 12px/1px 18px no-repeat,
      linear-gradient(var(--line),var(--line)) right 12px top 12px/18px 1px no-repeat,
      linear-gradient(var(--line),var(--line)) right 12px top 12px/1px 18px no-repeat,
      linear-gradient(var(--line),var(--line)) left 12px bottom 12px/18px 1px no-repeat,
      linear-gradient(var(--line),var(--line)) left 12px bottom 12px/1px 18px no-repeat,
      linear-gradient(var(--line),var(--line)) right 12px bottom 12px/18px 1px no-repeat,
      linear-gradient(var(--line),var(--line)) right 12px bottom 12px/1px 18px no-repeat;
    opacity:.65;
    pointer-events:none;
  }

  .hdr{
    padding:10px 12px 8px;
    border-bottom:1px dashed var(--line2);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    position:relative;
  }
  .hdr .title{
    font-size:12px;
    letter-spacing:.22em;
    text-transform:uppercase;
    color:var(--ink);
    white-space:nowrap;
  }
  .hdr .chip{
    font-size:11px;
    letter-spacing:.18em;
    text-transform:uppercase;
    color:var(--dim);
    border:1px solid var(--line2);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:3px 8px;
    white-space:nowrap;
  }
  .body{
    padding:12px;
    height: calc(100% - 44px);
    min-height:0;
    position:relative;
  }

  /* LEFT controls */
  .controls{
    display:grid;
    grid-template-rows: 1fr auto;
    gap:12px;
    height:100%;
    min-height:0;
  }
  .btnGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: repeat(3, 1fr);
    gap:10px;
    height:100%;
    min-height:0;
  }
  .btn{
    border-radius:14px;
    border:1px solid rgba(210,200,180,.22);
    background:
      radial-gradient(circle at 30% 25%, rgba(210,200,180,.10), rgba(0,0,0,.26));
    color:var(--ink);
    letter-spacing:.22em;
    text-transform:uppercase;
    font-weight:700;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px 12px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
    min-height:58px;
    user-select:none;
    transition: transform 80ms ease, border-color .2s ease, box-shadow .2s ease;
  }
  .btn:hover{
    border-color: rgba(255,245,220,.28);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.15), 0 0 24px rgba(210,200,180,.08);
  }
  .btn:active{ transform: translateY(1px); }
  .btn .tag2{
    font-size:10px;
    color:var(--dim);
    letter-spacing:.18em;
    font-weight:600;
  }
  .btn.disabled{
    opacity:.45;
    cursor:not-allowed;
    filter:saturate(.7);
  }

  .meter{
    border:1px solid rgba(210,200,180,.16);
    border-radius:14px;
    background: rgba(0,0,0,.18);
    padding:10px;
  }
  .meterRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    letter-spacing:.18em;
    text-transform:uppercase;
    font-size:11px;
    color:var(--dim);
    margin-bottom:8px;
  }
  .barline{
    height:8px;
    border-radius:999px;
    background: rgba(210,200,180,.10);
    border:1px solid rgba(210,200,180,.12);
    overflow:hidden;
  }
  .barfill{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(160,255,210,.65), rgba(255,210,120,.55), rgba(255,120,140,.55));
    box-shadow: 0 0 18px rgba(210,200,180,.10);
  }

  /* CENTER safe */
  .safeStage{
    height:100%;
    display:grid;
    grid-template-rows: auto 1fr auto;
    gap:12px;
  }

  .comboBox{
    border:1px solid rgba(210,200,180,.16);
    border-radius:14px;
    background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.14));
    padding:10px;
    letter-spacing:.18em;
    text-transform:uppercase;
    font-size:11px;
    color:var(--dim);
    overflow:hidden;
  }
  .comboBox b{color:var(--ink); letter-spacing:.22em;}
  .comboLine{
    margin-top:6px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .codeChip{
    border:1px solid rgba(210,200,180,.20);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:6px 10px;
    font-size:11px;
    color:var(--ink);
    letter-spacing:.22em;
  }
  .codeChip.done{
    border-color: rgba(160,255,210,.28);
    color: rgba(210,255,235,.95);
    box-shadow: 0 0 16px rgba(160,255,210,.10);
  }

  /* IRON safe realism */
  .safeFace{
    position:relative;
    border-radius: 18px;
    border:1px solid rgba(210,200,180,.22);
    background:
      radial-gradient(900px 420px at 50% 0%, rgba(255,245,220,.12), transparent 60%),
      radial-gradient(760px 520px at 25% 38%, rgba(210,200,180,.07), transparent 60%),
      radial-gradient(900px 650px at 70% 70%, rgba(0,0,0,.48), transparent 65%),
      /* pitted iron texture */
      radial-gradient(2px 2px at 12% 20%, rgba(255,255,255,.08) 0 1px, rgba(0,0,0,0) 2px),
      radial-gradient(2px 2px at 38% 64%, rgba(0,0,0,.14) 0 1px, rgba(0,0,0,0) 2px),
      radial-gradient(2px 2px at 62% 30%, rgba(255,255,255,.06) 0 1px, rgba(0,0,0,0) 2px),
      radial-gradient(2px 2px at 84% 58%, rgba(0,0,0,.16) 0 1px, rgba(0,0,0,0) 2px),
      linear-gradient(180deg, rgba(28,26,20,.86), rgba(10,9,7,.62));
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.30),
      inset 0 0 70px rgba(0,0,0,.30);
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:0;

    transform-origin: left center;
    transform: perspective(900px) rotateY(0deg);
    transition: transform 1.05s cubic-bezier(.18,.85,.28,1),
                box-shadow 1.05s ease;
  }
  .safeFace.open{
    transform: perspective(900px) rotateY(-11deg);
    box-shadow:
      inset -44px 0 90px rgba(0,0,0,.60),
      0 34px 86px rgba(0,0,0,.78);
  }
  .safeFace::before{
    content:"";
    position:absolute; inset:18px;
    border-radius:16px;
    border:1px solid rgba(210,200,180,.12);
    box-shadow:
      inset 0 0 0 2px rgba(0,0,0,.30),
      inset 0 0 0 1px rgba(255,255,255,.04);
    background:
      radial-gradient(600px 420px at 50% 10%, rgba(255,255,255,.05), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.28));
    opacity:.95;
    pointer-events:none;
  }

  .ironBolts{
    position:absolute;
    inset:16px;
    pointer-events:none;
    opacity:.55;
    background:
      radial-gradient(circle at 24px 24px, rgba(255,245,220,.26) 0 2px, rgba(0,0,0,0) 3px),
      radial-gradient(circle at calc(100% - 24px) 24px, rgba(255,245,220,.26) 0 2px, rgba(0,0,0,0) 3px),
      radial-gradient(circle at 24px calc(100% - 24px), rgba(255,245,220,.26) 0 2px, rgba(0,0,0,0) 3px),
      radial-gradient(circle at calc(100% - 24px) calc(100% - 24px), rgba(255,245,220,.26) 0 2px, rgba(0,0,0,0) 3px);
  }

  .rustEdge{
    position:absolute; inset:0;
    pointer-events:none;
    opacity:.22;
    background:
      radial-gradient(700px 500px at 18% 72%, rgba(180,100,50,.22), transparent 60%),
      radial-gradient(500px 420px at 78% 28%, rgba(120,60,20,.18), transparent 60%),
      radial-gradient(900px 700px at 50% 110%, rgba(0,0,0,.40), transparent 60%);
    mix-blend-mode: multiply;
  }

  .hasp{
    position:absolute;
    right:26px;
    top:50%;
    transform: translateY(-50%);
    width:88px;
    height:130px;
    border-radius:18px;
    border:1px solid rgba(210,200,180,.18);
    background:
      radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), rgba(0,0,0,.36)),
      linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.30));
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.26);
    opacity:.90;
    pointer-events:none;
  }
  .keyhole{
    position:absolute;
    left:50%; top:52%;
    transform: translate(-50%,-50%);
    width:18px; height:30px;
    border-radius:10px 10px 12px 12px;
    background: rgba(0,0,0,.70);
    border:1px solid rgba(255,255,255,.06);
    box-shadow: inset 0 0 18px rgba(0,0,0,.70);
  }
  .keyhole::after{
    content:"";
    position:absolute;
    left:50%; top:-7px;
    transform: translateX(-50%);
    width:14px; height:14px;
    border-radius:50%;
    background: rgba(0,0,0,.70);
    border:1px solid rgba(255,255,255,.06);
  }

  .plaque{
    position:absolute;
    left:26px;
    bottom:26px;
    width: 260px;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid rgba(210,200,180,.18);
    background:
      linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.26));
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.24),
      0 12px 20px rgba(0,0,0,.30);
    letter-spacing:.18em;
    text-transform:uppercase;
    font-size:10px;
    color: rgba(242,238,228,.86);
    opacity:.85;
    pointer-events:none;
  }
  .plaque b{ color: rgba(255,255,255,.92); letter-spacing:.22em; }

  /* Dial (simpler, beginner) */
  .dialWrap{
    width: min(var(--dialSize), 92%);
    aspect-ratio:1/1;
    position:relative;
    filter: drop-shadow(0 18px 44px rgba(0,0,0,.62));
    z-index:2;

    /* ✅ IMPORTANT for finger drag */
    touch-action: none;
    user-select: none;
    -webkit-user-select: none;
  }
  .dial{
    position:absolute; inset:0;
    border-radius:50%;
    background:
      radial-gradient(circle at 50% 45%, rgba(255,255,255,.10), transparent 56%),
      radial-gradient(circle at 50% 50%, rgba(210,200,180,.10), rgba(0,0,0,.30)),
      conic-gradient(from 0deg,
        rgba(255,245,220,.12),
        rgba(210,200,180,.05),
        rgba(255,245,220,.12));
    border:1px solid rgba(210,200,180,.22);
    box-shadow:
      inset 0 0 0 12px rgba(0,0,0,.20),
      inset 0 0 0 1px rgba(255,255,255,.04);
    transform: rotate(0deg);
    transition: transform 70ms linear;
    overflow:hidden;
  }
  .ticks{
    position:absolute; inset:12%;
    border-radius:50%;
    background:
      repeating-conic-gradient(
        from -90deg,
        rgba(242,238,228,.30) 0deg,
        rgba(242,238,228,.30) 1deg,
        rgba(0,0,0,0) 1deg,
        rgba(0,0,0,0) 8deg
      );
    mask: radial-gradient(circle, transparent 58%, #000 59%);
    opacity:.50;
  }
  .hub{
    position:absolute;
    left:50%; top:50%;
    transform: translate(-50%,-50%);
    width:28%;
    aspect-ratio:1/1;
    border-radius:50%;
    background:
      radial-gradient(circle at 35% 30%, rgba(255,255,255,.16), rgba(0,0,0,.40));
    border:1px solid rgba(210,200,180,.22);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.28);
  }

  .needle{
    position:absolute;
    left:50%; top:-10px;
    transform: translateX(-50%);
    width:0;height:0;
    border-left:11px solid transparent;
    border-right:11px solid transparent;
    border-bottom:22px solid rgba(242,238,228,.58);
    filter: drop-shadow(0 6px 12px rgba(0,0,0,.55));
    opacity:.88;
    z-index:3;
  }

  .window{
    position:absolute;
    top:12px; left:50%;
    transform: translateX(-50%);
    width: 190px;
    padding:8px 10px;
    border-radius: 12px;
    border:1px solid rgba(210,200,180,.20);
    background: linear-gradient(180deg, rgba(0,0,0,.62), rgba(0,0,0,.32));
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    text-align:center;
    letter-spacing:.28em;
    text-transform:uppercase;
    z-index:4;
  }
  .window .num{
    font-size:22px;
    color:var(--ink);
    text-shadow: 0 0 18px rgba(210,200,180,.10);
    font-weight:800;
  }
  .window .sub{
    margin-top:2px;
    font-size:10px;
    color:var(--dim);
    letter-spacing:.18em;
  }

  .prompt{
    position:absolute;
    bottom:14px; left:50%;
    transform: translateX(-50%);
    width: min(600px, 92%);
    padding:10px 12px;
    border-radius: 14px;
    border:1px solid rgba(210,200,180,.16);
    background: rgba(0,0,0,.30);
    box-shadow: 0 0 24px rgba(210,200,180,.08);
    text-align:center;
    letter-spacing:.18em;
    text-transform:uppercase;
    color:var(--dim);
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
    z-index:4;
  }
  .prompt.good{ border-color: rgba(160,255,210,.22); color: rgba(210,255,235,.95); }
  .prompt.bad{ border-color: rgba(255,120,140,.22); color: rgba(255,200,210,.95); }
  .prompt.warn{ border-color: rgba(255,210,120,.22); color: rgba(255,235,190,.95); }

  .progress{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    border:1px solid rgba(210,200,180,.16);
    border-radius:14px;
    background: rgba(0,0,0,.18);
    padding:10px 12px;
  }
  .dots{ display:flex; gap:8px; align-items:center; }
  .dot{
    width:12px;height:12px;border-radius:50%;
    border:1px solid rgba(210,200,180,.22);
    background: rgba(210,200,180,.08);
    box-shadow: 0 0 14px rgba(210,200,180,.06);
  }
  .dot.on{
    border-color: rgba(160,255,210,.35);
    background: rgba(160,255,210,.28);
    box-shadow: 0 0 18px rgba(160,255,210,.12);
  }
  .progText{
    font-size:11px;
    letter-spacing:.18em;
    text-transform:uppercase;
    color:var(--dim);
    white-space:nowrap;
  }
  .progText b{color:var(--ink); letter-spacing:.22em;}

  .stack{
    height:100%;
    display:grid;
    grid-template-rows: auto 1fr auto;
    gap:12px;
  }
  .modeBox{
    border:1px solid rgba(210,200,180,.16);
    border-radius:14px;
    background: rgba(0,0,0,.18);
    padding:10px;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .toggleRow{display:flex; gap:8px; flex-wrap:wrap;}
  .miniBtn{
    border-radius:999px;
    border:1px solid rgba(210,200,180,.20);
    background: rgba(0,0,0,.18);
    color:var(--ink);
    letter-spacing:.18em;
    text-transform:uppercase;
    font-size:11px;
    padding:7px 10px;
    cursor:pointer;
    user-select:none;
  }
  .miniBtn.active{
    border-color: rgba(160,255,210,.30);
    box-shadow: 0 0 18px rgba(160,255,210,.08);
  }
  .miniBtn:active{transform:translateY(1px);}

  .noteBox{
    border:1px solid rgba(210,200,180,.16);
    border-radius:14px;
    background: rgba(0,0,0,.18);
    padding:10px 12px;
    line-height:1.35;
    letter-spacing:.06em;
    color:rgba(242,238,228,.78);
    white-space:pre-wrap;
    overflow:hidden;
  }
  .hintBox{
    border:1px solid rgba(210,200,180,.16);
    border-radius:14px;
    background: rgba(0,0,0,.18);
    padding:10px 12px;
    letter-spacing:.16em;
    text-transform:uppercase;
    font-size:11px;
    color:var(--dim);
  }
  .hintBox b{color:var(--ink); letter-spacing:.22em;}

  .keys{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    font-size:11px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:var(--dim);
  }
  .key{
    border:1px solid rgba(210,200,180,.16);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:6px 10px;
    user-select:none;
  }
  .key b{color:var(--ink); letter-spacing:.18em;}

  .shake{ animation: shake .18s linear; }
  @keyframes shake{
    0%{transform:translate(0,0);}
    25%{transform:translate(-2px,1px);}
    50%{transform:translate(2px,-1px);}
    75%{transform:translate(-1px,-2px);}
    100%{transform:translate(0,0);}
  }

  /* ✅ MOBILE FIXES:
     - remove right panel (already)
     - remove movement buttons
     - keep only CRACK + OPEN on mobile
     - hide keyboard legend on mobile (optional)
  */
  @media (max-width: 980px){
    /* Hide dev-only folder paths on mobile */
    .panel:nth-child(3){
      display: none;
    }

    /* Rebalance layout after hiding panel */
    .main{
      grid-template-columns: 1fr;
      grid-template-rows: 1fr;
    }

    /* Hide dial movement buttons on mobile (finger drag replaces them) */
    #btnLeft, #btnRight, #btnSpinL, #btnSpinR{
      display:none !important;
    }

    /* Make Crack/Open large and full width */
    #btnCrack, #btnOpen{
      min-height: 64px;
      font-size: 12px;
      width: 100%;
    }

    /* Turn button grid into a simple 1-col stack */
    .btnGrid{
      grid-template-columns: 1fr !important;
      grid-template-rows: auto auto !important;
    }

    /* Optional: hide bottom keyboard legend on mobile to reduce clutter */
    .bar:last-child .keys:first-child{
      display:none;
    }
  }

</style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="row">
        <div class="left">
          <span class="pill">Bench: <b id="bench">Crowbar-12</b></span>
          <span class="pill">Safe: <b>Dusty Gulch</b></span>
          <span class="pill">Type: <b>Innocent Lock</b></span>
          <span class="pill">Cracks: <b id="cracks">000</b></span>
          <span class="pill">Jams: <b id="jams">000</b></span>
          <span class="pill">Wallet: <b id="wallet">$0</b></span>
        </div>
        <div class="right">
          <span class="pill">Mode: <b id="modeLabel">Casual</b></span>
          <span class="pill" id="timerPill">Window: <b id="timer">00:30</b></span>
          <span class="pill">Uptime: <b id="uptime">00:00:00</b></span>
          <span class="pill">Clock: <b id="clock">--:--:--</b></span>
          <span class="pill">Press <b>B</b> Bench • <b>F</b> Fullscreen • <b>R</b> Reset</span>
        </div>
      </div>
    </div>

    <div class="main">
      <!-- LEFT -->
      <div class="panel">
        <div class="hdr">
          <div class="title">Hand Controls</div>
          <div class="chip">Input</div>
        </div>
        <div class="body controls">
          <div class="btnGrid">
            <button class="btn" id="btnLeft"><span>Left</span><span class="tag2">−1</span></button>
            <button class="btn" id="btnRight"><span>Right</span><span class="tag2">+1</span></button>
            <button class="btn" id="btnSpinL"><span>Spin ◀</span><span class="tag2">−5</span></button>
            <button class="btn" id="btnSpinR"><span>Spin ▶</span><span class="tag2">+5</span></button>
            <button class="btn" id="btnCrack"><span>Crack</span><span class="tag2">Commit</span></button>
            <button class="btn disabled" id="btnOpen"><span>Open</span><span class="tag2">Latch</span></button>
          </div>

          <div class="meter">
            <div class="meterRow">
              <span>Noise</span>
              <span><b id="noiseTxt">0%</b></span>
            </div>
            <div class="barline"><div class="barfill" id="noiseFill"></div></div>
            <div style="margin-top:10px; font-size:11px; color:var(--dim); letter-spacing:.08em; line-height:1.35;">
              Iron lock: forgiving tolerances. You’ll hear a <b>duller thud-click</b> when close.
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER -->
      <div class="panel">
        <div class="hdr">
          <div class="title">Innocent Lock</div>
          <div class="chip">Iron</div>
        </div>
        <div class="body safeStage">
          <div class="comboBox">
            <div><b id="comboHdr">Combination</b> <span id="comboSub">• visible in casual</span></div>
            <div class="comboLine" id="comboLine"></div>
          </div>

          <div class="safeFace" id="safeFace">
            <div class="ironBolts" aria-hidden="true"></div>
            <div class="rustEdge" aria-hidden="true"></div>
            <div class="hasp" aria-hidden="true"><div class="keyhole"></div></div>
            <div class="plaque" aria-hidden="true"><b>Dusty Gulch</b> • Iron • 1872</div>

            <div class="dialWrap" aria-label="Safe dial">
              <div class="needle"></div>

              <div class="window" id="numWindow">
                <div class="num" id="numRead">00</div>
                <div class="sub">dial 0–59</div>
              </div>

              <div class="dial" id="dial">
                <div class="ticks"></div>
                <div class="hub"></div>
              </div>
            </div>

            <div class="prompt" id="prompt">IRON LOCK • TAKE IT SLOW</div>
          </div>

          <div class="progress">
            <div class="dots" id="dots"></div>
            <div class="progText">Progress: <b id="prog">0/2</b> • Slips: <b id="slip">0</b>/3</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="hdr">
          <div class="title">Kit & Notes</div>
          <div class="chip">Beginner</div>
        </div>
        <div class="body stack">
          <div class="modeBox">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <span class="pill" style="padding:6px 10px;">Mode</span>
              <div class="toggleRow">
                <button class="miniBtn active" id="modeCasual">Casual</button>
                <button class="miniBtn" id="modeEndurance">Endurance</button>
              </div>
            </div>
            <div class="toggleRow">
              <button class="miniBtn" id="newSafe">New Safe</button>
            </div>
          </div>

          <div class="noteBox" id="notes"></div>

          <div class="hintBox">
            <div><b>Innocent lock</b></div>
            <div style="margin-top:8px; line-height:1.4;">
              • 2 commits (simple)<br/>
              • forgiving tolerance (iron)<br/>
              • more slips allowed<br/>
              <div style="margin-top:8px; opacity:.9;">
                • CRACK commits • OPEN finishes
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="bar">
      <div class="row">
        <div class="keys">
          <span class="key"><b>←</b> Left</span>
          <span class="key"><b>→</b> Right</span>
          <span class="key"><b>A</b> Spin ◀</span>
          <span class="key"><b>D</b> Spin ▶</span>
          <span class="key"><b>C</b> Crack</span>
          <span class="key"><b>O</b> Open</span>
          <span class="key"><b>M</b> Mode</span>
          <span class="key"><b>N</b> New Safe</span>
          <span class="key"><b>B</b> Bench</span>
        </div>
        <div class="keys">
          <span class="key">FPS: <b id="fps">--</b></span>
          <span class="key">Status: <b id="status">Steady</b></span>
        </div>
      </div>
    </div>
  </div>

  <div class="grain"></div>
  <div class="vignette"></div>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const pad2 = (n) => String(n).padStart(2,"0");
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const wrap60 = (n) => ((n % 60) + 60) % 60;
  const rand = (a,b) => a + Math.random()*(b-a);
  const randi = (a,b) => Math.floor(rand(a,b+1));

  /* ===== MODE DETECT (Endurance hub) ===== */
  const params = new URLSearchParams(location.search);
  const BOOT_MODE = (params.get("mode") || localStorage.getItem("sc_mode") || "casual").toLowerCase();
  const BOOT_IS_ENDURANCE = (BOOT_MODE === "endurance");

  /* ===== Shared save keys ===== */
  const K = {
    money: "sc_money",
    cracks: "sc_totalCracks",
    jams: "sc_totalJams",
    bestRun: "sc_bestRun",
    ach: "sc_ach",
    recent: "sc_recent",
    bench: "sc_bench"
  };

  function getNum(key, def=0){
    const v = localStorage.getItem(key);
    const n = Number(v);
    return Number.isFinite(n) ? n : def;
  }
  function setNum(key, val){
    localStorage.setItem(key, String(Math.max(0, Math.floor(val))));
  }
  function getJSON(key, def){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return def;
      return JSON.parse(raw);
    }catch(e){ return def; }
  }
  function setJSON(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }
  function pushRecent(line){
    const recent = getJSON(K.recent, []);
    const out = [String(line), ...recent].slice(0, 10);
    setJSON(K.recent, out);
  }

  // Seed if needed
  if(localStorage.getItem(K.money) === null) setNum(K.money, 0);
  if(localStorage.getItem(K.cracks) === null) setNum(K.cracks, 0);
  if(localStorage.getItem(K.jams) === null) setNum(K.jams, 0);
  if(localStorage.getItem(K.bestRun) === null) setNum(K.bestRun, 0);
  if(localStorage.getItem(K.ach) === null) setJSON(K.ach, []);
  if(localStorage.getItem(K.recent) === null) setJSON(K.recent, []);
  if(localStorage.getItem(K.bench) === null) localStorage.setItem(K.bench, "Crowbar-12");

  /* ===== Clock + uptime ===== */
  const start = Date.now();
  function tickTop(){
    const now = new Date();
    $("#clock").textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
    const t = Math.floor((Date.now()-start)/1000);
    const h = Math.floor(t/3600), m = Math.floor((t%3600)/60), s = t%60;
    $("#uptime").textContent = `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  }
  setInterval(tickTop, 250);
  tickTop();

  /* ===== Audio ===== */
  let ac = null;
  function armAudio(){
    if(ac) return;
    try{ ac = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){}
  }
  function tone(freq=220, dur=0.05, type="sine", gain=0.06){
    if(!ac) return;
    const t = ac.currentTime;
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(gain, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.connect(g); g.connect(ac.destination);
    o.start(t); o.stop(t+dur+0.02);
  }

  // Iron sounds: duller, less “ring”
  const clickIron = () => tone(420, 0.060, "triangle", 0.050);
  const thudIron  = () => { tone(160, 0.10, "square", 0.06); tone(110, 0.12, "sine", 0.04); };
  const scrape    = () => tone(220, 0.03, "sawtooth", 0.028);
  const failBuzz  = () => tone(70,  0.16, "square", 0.085);

  const thudFoot  = (vol=0.055) => {
    if(!ac) return;
    const t = ac.currentTime;
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = "triangle";
    o.frequency.value = 86;
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(vol,t+.02);
    g.gain.exponentialRampToValueAtTime(0.0001,t+.18);
    o.connect(g); g.connect(ac.destination);
    o.start(t); o.stop(t+.22);
  };

  /* ===== State ===== */
  const TUMBLERS = 2; // innocent = simpler
  const state = {
    mode: "casual",
    number: 0,
    combo: [],
    step: 0,
    slips: 0,
    noise: 0,
    spinning: false,

    lastInZone: false,

    // endurance timing: resets after each correct CRACK
    runIndex: 0,
    windowLimit: 30,
    windowLeft: 30,
    windowMin: 12,
    shrinkPerSafe: 2,
    timeExpired: false,

    footstepTimer: null,
    lockoutUntil: 0
  };

  /* ===== Elements ===== */
  const dialEl = $("#dial");
  const numRead = $("#numRead");
  const numWindow = $("#numWindow");
  const prompt = $("#prompt");
  const dotsEl = $("#dots");
  const progEl = $("#prog");
  const slipEl = $("#slip");
  const comboLine = $("#comboLine");
  const comboHdr = $("#comboHdr");
  const comboSub = $("#comboSub");
  const notes = $("#notes");
  const safeFace = $("#safeFace");

  const btnLeft = $("#btnLeft");
  const btnRight = $("#btnRight");
  const btnSpinL = $("#btnSpinL");
  const btnSpinR = $("#btnSpinR");
  const btnCrack = $("#btnCrack");
  const btnOpen = $("#btnOpen");

  const noiseFill = $("#noiseFill");
  const noiseTxt = $("#noiseTxt");

  const timerEl = $("#timer");
  const timerPill = $("#timerPill");

  /* ===== Helpers ===== */
  function fmtTime(sec){
    const s = Math.max(0, Math.ceil(sec));
    const m = Math.floor(s/60);
    const r = s % 60;
    return `${pad2(m)}:${pad2(r)}`;
  }
  function updateWalletUI(){
    const money = getNum(K.money, 0);
    $("#wallet").textContent = `$${money}`;
  }
  function updateTimerUI(){
    if(state.mode !== "endurance"){
      timerEl.textContent = "—:—";
      timerPill.classList.remove("hot","danger");
      return;
    }
    timerEl.textContent = fmtTime(state.windowLeft);
    timerPill.classList.remove("hot","danger");
    const pct = state.windowLimit > 0 ? (state.windowLeft / state.windowLimit) : 0;
    if(pct <= 0.25) timerPill.classList.add("danger");
    else if(pct <= 0.45) timerPill.classList.add("hot");
  }

  function updateFootsteps(){
    if(state.mode !== "endurance") { stopFootsteps(); return; }
    const pct = state.windowLimit > 0 ? (state.windowLeft / state.windowLimit) : 1;
    document.body.classList.remove("urgent","danger");

    const clearFeet = () => {
      if(state.footstepTimer){
        clearInterval(state.footstepTimer);
        state.footstepTimer = null;
      }
    };

    if(pct < 0.50 && pct > 0.25){
      document.body.classList.add("urgent");
      if(!state.footstepTimer){
        state.footstepTimer = setInterval(()=> thudFoot(0.045), 1280);
      }
    } else if(pct <= 0.25){
      document.body.classList.add("danger");
      clearFeet();
      state.footstepTimer = setInterval(()=> thudFoot(0.070), 760);
    } else {
      clearFeet();
    }
  }
  function stopFootsteps(){
    document.body.classList.remove("urgent","danger");
    if(state.footstepTimer){
      clearInterval(state.footstepTimer);
      state.footstepTimer = null;
    }
  }

  function applyModeUI(){
    // Hide practice number window in endurance
    if(state.mode === "endurance"){
      numWindow.style.display = "none";
    } else {
      numWindow.style.display = "";
    }
  }

  function setNotes(){
    notes.textContent =
`iron lock: forgiving, old-town simple
—
innocent rule:
• 2 commits total
• wide tolerance (iron)
• more slips allowed
• Endurance timer resets after each correct crack`;
  }
  function addNote(line){
    const lines = notes.textContent.split("\n");
    const out = [...lines];
    out.splice(1, 0, line);
    while(out.length > 16) out.pop();
    notes.textContent = out.join("\n");
  }

  function addNoise(amount){
    state.noise = clamp(state.noise + amount, 0, 100);
    noiseFill.style.width = `${state.noise}%`;
    noiseTxt.textContent = `${Math.round(state.noise)}%`;
  }

  function newCombo(){
    const arr = [];
    let last = -999;
    for(let i=0;i<TUMBLERS;i++){
      let n = Math.floor(rand(0,60));
      if(Math.abs(n-last) <= 1) n = wrap60(n + Math.floor(rand(6,15)));
      arr.push(n);
      last = n;
    }
    return arr;
  }

  function buildDots(){
    dotsEl.innerHTML = "";
    for(let i=0;i<TUMBLERS;i++){
      const d = document.createElement("div");
      d.className = "dot" + (i < state.step ? " on" : "");
      dotsEl.appendChild(d);
    }
  }

  function renderCombo(){
    comboLine.innerHTML = "";
    if(state.mode === "casual"){
      comboHdr.textContent = "Combination";
      comboSub.textContent = "• visible in casual";
      state.combo.forEach((n,i)=>{
        const chip = document.createElement("span");
        chip.className = "codeChip" + (i < state.step ? " done" : "");
        chip.textContent = String(n).padStart(2,"0");
        comboLine.appendChild(chip);

        if(i !== state.combo.length-1){
          const a = document.createElement("span");
          a.className = "codeChip";
          a.style.opacity = "0.55";
          a.style.padding = "6px 8px";
          a.textContent = "→";
          comboLine.appendChild(a);
        }
      });
    } else {
      comboHdr.textContent = "Endurance";
      comboSub.textContent = "• combination hidden";
      const chipA = document.createElement("span");
      chipA.className = "codeChip";
      chipA.textContent = `TUMBLER ${state.step+1}/${TUMBLERS}`;
      comboLine.appendChild(chipA);

      const chipB = document.createElement("span");
      chipB.className = "codeChip";
      chipB.style.opacity = "0.70";
      chipB.textContent = "LISTEN";
      comboLine.appendChild(chipB);
    }
  }

  // Iron = forgiving tolerance
  function circularDist(a,b){
    const d = Math.abs(wrap60(a-b));
    return Math.min(d, 60-d);
  }
  function inZone(num, target){
    return circularDist(num, target) <= 2; // ±2 (easier)
  }

  function showPrompt(text, kind){
    prompt.classList.remove("good","bad","warn");
    if(kind) prompt.classList.add(kind);
    prompt.textContent = text;
  }

  function setDialNumber(n){
    state.number = wrap60(n);
    numRead.textContent = String(state.number).padStart(2,"0");

    const degPer = 360/60;
    const ang = state.number * degPer;
    dialEl.style.transform = `rotate(${ang}deg)`;

    updateClickState();
  }

  // No visual hints: only dull click when entering the wide zone.
  function updateClickState(){
    if(state.step >= TUMBLERS){
      state.lastInZone = false;
      return;
    }
    const target = state.combo[state.step];
    const inside = inZone(state.number, target);

    if(inside && !state.lastInZone){
      clickIron();
      thudIron();
      addNote(`click: near (t${state.step+1})`);
    }
    state.lastInZone = inside;
    showPrompt("IRON LOCK • TAKE IT SLOW", "");
  }

  function setButtonsEnabled(on){
    const all = [btnLeft, btnRight, btnSpinL, btnSpinR, btnCrack];
    all.forEach(b => b.classList.toggle("disabled", !on));
    if(!on) all.forEach(b => b.setAttribute("disabled","disabled"));
    else all.forEach(b => b.removeAttribute("disabled"));

    if(state.step < TUMBLERS){
      btnOpen.classList.add("disabled");
      btnOpen.setAttribute("disabled","disabled");
    } else {
      btnOpen.classList.remove("disabled");
      btnOpen.removeAttribute("disabled");
    }
  }
  function inputAllowed(){
    return performance.now() >= state.lockoutUntil;
  }

  async function spin(delta){
    if(state.spinning) return;
    if(!inputAllowed()) return;
    armAudio();
    state.spinning = true;
    setButtonsEnabled(false);
    $("#status").textContent = "Spinning";

    const steps = 5;
    const dir = delta > 0 ? 1 : -1;

    for(let i=0;i<steps;i++){
      setDialNumber(state.number + dir);
      scrape();
      addNoise(state.mode === "endurance" ? 1.8 : 1.2);
      safeFace.classList.add("shake");
      await new Promise(r => setTimeout(r, 60));
      safeFace.classList.remove("shake");
      await new Promise(r => setTimeout(r, 34));
    }
    thudIron();
    await new Promise(r => setTimeout(r, 110));
    $("#status").textContent = "Steady";
    state.spinning = false;
    setButtonsEnabled(true);
    updateClickState();
  }

  function nudge(delta){
    if(state.spinning) return;
    if(!inputAllowed()) return;
    armAudio();
    setDialNumber(state.number + delta);
    scrape();
    addNoise(state.mode === "endurance" ? 0.70 : 0.45);
  }

  /* ==========================================================
     ✅ FINGER DIAL (mobile + desktop touch)
     Drag around the dial. Replaces Left/Right/Spin buttons on mobile.
     ========================================================== */
  function enableDialDrag(){
    const wrap = document.querySelector(".dialWrap");
    if(!wrap) return;

    const degPerStep = 360 / 60;

    let dragging = false;
    let startAngle = 0;
    let startNumber = 0;
    let lastStep = 0;

    const getCenter = () => {
      const r = wrap.getBoundingClientRect();
      return { cx: r.left + r.width/2, cy: r.top + r.height/2 };
    };

    const pointerAngle = (e) => {
      const { cx, cy } = getCenter();
      const dx = e.clientX - cx;
      const dy = e.clientY - cy;
      return Math.atan2(dy, dx) * (180 / Math.PI);
    };

    const normDelta = (a, b) => {
      let d = a - b;
      while(d > 180) d -= 360;
      while(d < -180) d += 360;
      return d;
    };

    const onDown = (e) => {
      armAudio();
      if(state.spinning) return;
      if(!inputAllowed()) return;

      dragging = true;
      try{ wrap.setPointerCapture(e.pointerId); }catch(err){}

      startAngle = pointerAngle(e);
      startNumber = state.number;
      lastStep = 0;

      $("#status").textContent = "Dialing";
      e.preventDefault?.();
    };

    const onMove = (e) => {
      if(!dragging) return;
      if(state.spinning) return;
      if(!inputAllowed()) return;

      const a = pointerAngle(e);
      const d = normDelta(a, startAngle);

      // Convert to dial steps
      const steps = Math.round(d / degPerStep);

      if(steps !== lastStep){
        lastStep = steps;

        // Feel: drag clockwise increases number.
        // atan2 grows CCW, so invert.
        const next = startNumber - steps;

        setDialNumber(next);

        // tiny feedback
        scrape();
        addNoise(state.mode === "endurance" ? 0.35 : 0.22);
      }

      e.preventDefault?.();
    };

    const onUp = () => {
      if(!dragging) return;
      dragging = false;
      $("#status").textContent = "Steady";
    };

    // Stop scroll/zoom stealing the gesture
    wrap.style.touchAction = "none";

    wrap.addEventListener("pointerdown", onDown, { passive:false });
    window.addEventListener("pointermove", onMove, { passive:false });
    window.addEventListener("pointerup", onUp);
    window.addEventListener("pointercancel", onUp);
  }

  function jam(msg){
    const lifetimeJams = getNum(K.jams, 0) + 1;
    setNum(K.jams, lifetimeJams);

    const localJams = Number($("#jams").textContent) + 1;
    $("#jams").textContent = String(localJams).padStart(3,"0");

    showPrompt(msg || "JAM • IRON BINDS", "bad");
    failBuzz(); failBuzz();
    addNote("jam: slipped — reset");
    pushRecent("JAM on Iron Lock.");

    $("#status").textContent = "Jammed";
    setButtonsEnabled(false);
    btnOpen.classList.add("disabled");
    btnOpen.setAttribute("disabled","disabled");
    stopFootsteps();

    setTimeout(() => {
      if(state.mode === "endurance"){
        beginNewSafe(true);
      } else {
        $("#status").textContent = "Steady";
        setButtonsEnabled(true);
        showPrompt("JAM CLEARED • TRY AGAIN", "warn");
      }
    }, 1200);
  }

  function computeWindowLimit(){
    const start = 30;
    const min = state.windowMin;
    const shrink = state.runIndex * state.shrinkPerSafe;
    return Math.max(min, start - shrink);
  }
  function resetCrackWindow(){
    state.windowLimit = computeWindowLimit();
    state.windowLeft = state.windowLimit;
    state.timeExpired = false;
    updateTimerUI();
    updateFootsteps();
  }

  function doCrack(){
    if(state.spinning) return;
    if(!inputAllowed()) return;
    armAudio();

    if(state.step >= TUMBLERS){
      showPrompt("ALL SET • PRESS OPEN", "good");
      thudIron();
      return;
    }

    const target = state.combo[state.step];
    const ok = inZone(state.number, target);

    if(ok){
      state.step++;
      buildDots();
      progEl.textContent = `${state.step}/${TUMBLERS}`;
      renderCombo();
      showPrompt(`SET • ${state.step}/${TUMBLERS}`, "good");
      thudIron();
      addNote(`set: tumbler ${state.step}`);
      pushRecent(`Iron Lock: tumbler ${state.step}/${TUMBLERS} set.`);
      $("#status").textContent = "Set";
      setTimeout(()=> $("#status").textContent = "Steady", 520);

      state.lastInZone = false;

      // Reset endurance timer after each correct crack
      if(state.mode === "endurance"){
        resetCrackWindow();
      }

      if(state.step >= TUMBLERS){
        btnOpen.classList.remove("disabled");
        btnOpen.removeAttribute("disabled");
        showPrompt("READY • PRESS OPEN", "good");
      }
    } else {
      state.slips++;
      slipEl.textContent = String(state.slips);
      failBuzz();
      safeFace.classList.add("shake");
      setTimeout(()=> safeFace.classList.remove("shake"), 180);

      showPrompt("SLIP • WRONG CRACK", "bad");
      addNote(`slip: wrong crack (${state.slips}/3)`);
      pushRecent("Slip on Iron Lock.");
      $("#status").textContent = "Slip";
      setTimeout(()=> $("#status").textContent = "Steady", 650);

      addNoise(state.mode === "endurance" ? 6 : 4);
      if(state.slips >= 3) jam("JAM • OLD IRON SNAPS");
    }
  }

  function openDoor(){
    safeFace.classList.add("open");
    thudIron();
    setTimeout(()=> thudIron(), 170);
    addNote("door: creak");
  }
  function closeDoor(){
    safeFace.classList.remove("open");
  }

  function doOpen(){
    if(state.step < TUMBLERS || state.spinning) return;
    if(!inputAllowed()) return;
    armAudio();

    const reward = (state.mode === "endurance") ? randi(10,16) : randi(7,13);

    setNum(K.cracks, getNum(K.cracks, 0) + 1);
    setNum(K.money, getNum(K.money, 0) + reward);

    $("#cracks").textContent = String(Number($("#cracks").textContent) + 1).padStart(3,"0");
    updateWalletUI();

    showPrompt(`OPEN • +$${reward}`, "good");
    $("#status").textContent = "Cracked";
    pushRecent(`Opened Iron Lock (+$${reward}).`);

    setButtonsEnabled(false);
    btnOpen.classList.add("disabled");
    btnOpen.setAttribute("disabled","disabled");

    openDoor();
    stopFootsteps();

    setTimeout(() => {
      if(state.mode === "endurance"){
        closeDoor();
        beginNewSafe(true);
      } else {
        showPrompt("PRESS NEW SAFE • OR SWITCH TO ENDURANCE", "warn");
        $("#status").textContent = "Steady";
        setButtonsEnabled(true);
      }
    }, 1100);
  }

  function setMode(m){
    state.mode = m;
    $("#modeLabel").textContent = m === "casual" ? "Casual" : "Endurance";
    $("#modeCasual").classList.toggle("active", m==="casual");
    $("#modeEndurance").classList.toggle("active", m==="endurance");

    applyModeUI();

    addNote(m==="endurance" ? "mode: endurance — hidden combo" : "mode: casual — combo shown");
    renderCombo();
    if(m !== "endurance") stopFootsteps();
    updateTimerUI();
  }

  function beginNewSafe(advance){
    closeDoor();

    state.number = 0;
    state.combo = newCombo();
    state.step = 0;
    state.slips = 0;
    state.noise = 0;
    state.spinning = false;
    state.lastInZone = false;
    state.lockoutUntil = 0;

    // Endurance: advance shrinks. Casual: never shrink.
    if(state.mode === "endurance"){
      if(advance) state.runIndex++;
      else state.runIndex = 0;
      resetCrackWindow();
    } else {
      state.runIndex = 0;
      state.windowLeft = state.windowLimit = 30;
      state.timeExpired = false;
      updateTimerUI();
    }

    slipEl.textContent = "0";
    progEl.textContent = `0/${TUMBLERS}`;
    $("#status").textContent = "Steady";
    noiseFill.style.width = "0%";
    noiseTxt.textContent = "0%";

    buildDots();
    renderCombo();
    setDialNumber(randi(0,59));
    showPrompt("IRON LOCK • TAKE IT SLOW", "");
    setButtonsEnabled(true);
    btnOpen.classList.add("disabled");
    btnOpen.setAttribute("disabled","disabled");
  }

  function hardReset(){
    $("#cracks").textContent = "000";
    $("#jams").textContent = "000";
    state.runIndex = 0;
    setNotes();
    stopFootsteps();
    beginNewSafe(false);
    showPrompt("RESET • EASY HANDS", "warn");
  }

  function wire(){
    const arm = () => armAudio();
    [btnLeft,btnRight,btnSpinL,btnSpinR,btnCrack,btnOpen, $("#modeCasual"), $("#modeEndurance"), $("#newSafe")]
      .forEach(el => el && el.addEventListener("pointerdown", arm));

    btnLeft.addEventListener("click", () => nudge(-1));
    btnRight.addEventListener("click", () => nudge(+1));
    btnSpinL.addEventListener("click", () => spin(-5));
    btnSpinR.addEventListener("click", () => spin(+5));
    btnCrack.addEventListener("click", doCrack);
    btnOpen.addEventListener("click", doOpen);

    $("#modeCasual").addEventListener("click", () => {
      localStorage.removeItem("sc_mode");
      setMode("casual");
      beginNewSafe(false);
      showPrompt("CASUAL • COMBINATION VISIBLE", "warn");
      setTimeout(()=> showPrompt("IRON LOCK • TAKE IT SLOW", ""), 900);
    });

    $("#modeEndurance").addEventListener("click", () => {
      localStorage.setItem("sc_mode","endurance");
      setMode("endurance");
      beginNewSafe(false);
      showPrompt("ENDURANCE • TIMER RESETS AFTER EACH CRACK", "warn");
      setTimeout(()=> showPrompt("IRON LOCK • TAKE IT SLOW", ""), 1100);
    });

    $("#newSafe").addEventListener("click", () => {
      if(state.mode === "endurance") beginNewSafe(true);
      else beginNewSafe(false);
    });

    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if(k === "arrowleft") nudge(-1);
      if(k === "arrowright") nudge(+1);
      if(k === "a") spin(-5);
      if(k === "d") spin(+5);
      if(k === "c") doCrack();
      if(k === "o") doOpen();
      if(k === "m"){
        const next = (state.mode === "casual" ? "endurance" : "casual");
        if(next === "endurance") localStorage.setItem("sc_mode","endurance");
        else localStorage.removeItem("sc_mode");
        setMode(next);
        beginNewSafe(false);
      }
      if(k === "n"){
        if(state.mode === "endurance") beginNewSafe(true);
        else beginNewSafe(false);
      }
      if(k === "r") hardReset();
      if(k === "f") toggleFullscreen();
      if(k === "b"){
        localStorage.removeItem("sc_mode");
        location.href = "../index.html";
      }
    });
  }

  async function toggleFullscreen(){
    try{
      if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    }catch(e){}
  }

  /* ===== FPS ===== */
  let fpsFrames = 0, fpsLast = performance.now();
  function fpsTick(now){
    fpsFrames++;
    const dt = now - fpsLast;
    if(dt >= 500){
      const fps = Math.round((fpsFrames*1000)/dt);
      $("#fps").textContent = String(fps);
      fpsFrames = 0;
      fpsLast = now;
    }
  }

  /* ===== Main loop ===== */
  let last = performance.now();
  function loop(now){
    const dt = now - last;
    last = now;

    const status = $("#status").textContent;

    if(state.mode === "endurance" && !state.timeExpired && status !== "Jammed" && status !== "Cracked"){
      state.windowLeft -= dt/1000;

      if(state.windowLeft <= 0){
        state.windowLeft = 0;
        state.timeExpired = true;
        updateTimerUI();
        jam("TIME UP • BOOTS ON WOOD");
      } else {
        updateTimerUI();
      }
      updateFootsteps();
    }

    const decay = (state.mode === "endurance" ? 0.010 : 0.016) * dt;
    if(state.noise > 0){
      state.noise = Math.max(0, state.noise - decay);
      noiseFill.style.width = `${state.noise}%`;
      noiseTxt.textContent = `${Math.round(state.noise)}%`;
    }

    fpsTick(now);
    requestAnimationFrame(loop);
  }

  /* ===== Init ===== */
  $("#bench").textContent = localStorage.getItem("sc_bench") || "Crowbar-12";
  updateWalletUI();
  setNotes();

  // BOOT: if endurance hub launched us, start in endurance immediately
  setMode(BOOT_IS_ENDURANCE ? "endurance" : "casual");
  beginNewSafe(false);

  pushRecent(`Opened: Innocent Lock (Iron, 1872) — ${BOOT_IS_ENDURANCE ? "ENDURANCE" : "CASUAL"}.`);

  wire();

  /* ✅ turn on finger dial */
  enableDialDrag();

  requestAnimationFrame(loop);
  window.addEventListener("pointerdown", armAudio, { once:true });
})();
</script>
</body>
</html>
