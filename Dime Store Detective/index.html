<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Detective Interrogation – Case One</title>

<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  body{
    height:100vh;
    background:#050814;
    color:#e5e7eb;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    display:flex;
    justify-content:center;
    align-items:center;
    overflow:hidden;
  }

  .game{
    width:1100px;
    height:650px;
    position:relative;
    background:radial-gradient(circle at 20% 10%, #1f2937 0, #020617 55%);
    box-shadow:0 40px 120px rgba(0,0,0,.9);
    border-radius:18px;
    border:1px solid rgba(148,163,184,.35);
  }

  /* Detective canvas (left) */
  #detective{
    position:absolute;
    top:160px;
    left:-360px; /* off-screen start */
    width:300px;
    height:400px;
    image-rendering:pixelated;
    transition:left .7s ease-out, opacity .7s ease-out;
    filter:drop-shadow(0 0 24px #000a);
    opacity:0;              /* hidden at start */
  }
  #detective.visible{
    left:60px;
    opacity:1;              /* fades / slides in */
  }

  /* Right-side canvas (suspect OR Wren) */
  #suspect{
    position:absolute;
    top:80px;
    right:40px;
    image-rendering:pixelated;
    filter:drop-shadow(0 0 24px #000a);
  }

  /* Top controls */
  #suspectTabs{
    position:absolute;
    top:32px;
    right:40px;
    display:flex;
    align-items:center;
    gap:12px;
    max-width:60%;
  }

  /* inner flex just for the suspect chips */
  #suspectTabsInner{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    justify-content:flex-end;
  }

  .suspect-tab{
    padding:6px 12px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.9);
    color:#e5e7eb;
    font-size:.8rem;
    letter-spacing:.08em;
    text-transform:uppercase;
    cursor:pointer;
    opacity:.6;
    transition:.15s;
  }
  .suspect-tab:hover{
    opacity:.9;
    background:#111827;
  }
  .suspect-tab.active{
    opacity:1;
    background:#1e293b;
    border-color:rgba(148,163,184,.9);
  }

  #topLeftButtons{
    position:absolute;
    top:32px;
    left:40px;
    display:flex;
    gap:8px;
  }
  .small-btn{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.9);
    color:#e5e7eb;
    font-size:.78rem;
    letter-spacing:.06em;
    text-transform:uppercase;
    cursor:pointer;
    opacity:.8;
    transition:.15s;
  }
  .small-btn:hover{
    opacity:1;
    background:#111827;
  }

  /* Question list */
  #questions{
    position:absolute;
    left:260px;
    right:400px;
    bottom:220px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .question-btn{
    padding:9px 12px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.45);
    background:rgba(15,23,42,.9);
    color:#e5e7eb;
    text-align:left;
    font-size:.95rem;
    cursor:pointer;
    backdrop-filter:blur(10px);
    transition:background .15s, transform .05s;
  }
  .question-btn:hover:not(.used):not(:disabled){
    background:#111827;
    transform:translateY(-1px);
  }
  .question-btn.used,
  .question-btn:disabled{
    opacity:.35;
    cursor:default;
  }

  /* Dialogue box (answer) */
  .dialogue-box{
    position:absolute;
    left:220px;
    right:220px;
    bottom:40px;
    min-height:110px;
    padding:14px 18px;
    background:rgba(15,23,42,.92);
    border-radius:14px;
    border:1px solid rgba(51,65,85,.8);
    backdrop-filter:blur(16px);
    box-shadow:0 18px 60px rgba(0,0,0,.8);
    font-size:1.02rem;
    line-height:1.4rem;
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .dialogue-label{
    font-size:.8rem;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:rgba(148,163,184,.9);
  }
  .dialogue-text{
    white-space:pre-wrap;
  }

  /* Accuse + Next Case pills in top bar */
  #accuseBtn{
    padding:6px 14px;
    border-radius:999px;
    border:1px solid rgba(248,113,113,.8);
    background:rgba(127,29,29,.9);
    color:#fee2e2;
    font-size:.75rem;
    letter-spacing:.12em;
    text-transform:uppercase;
    cursor:pointer;
    transition:.15s;
    white-space:nowrap;
  }
  #accuseBtn:hover:not(:disabled){
    background:#b91c1c;
  }
  #accuseBtn:disabled{
    opacity:.4;
    cursor:default;
  }

  #nextCaseBtn{
    padding:6px 14px;
    border-radius:999px;
    border:1px solid rgba(52,211,153,.8);
    background:rgba(6,95,70,.95);
    color:#ecfdf5;
    font-size:.75rem;
    letter-spacing:.12em;
    text-transform:uppercase;
    cursor:pointer;
    transition:.15s;
    white-space:nowrap;
    display:none;
  }
  #nextCaseBtn:hover{
    background:#047857;
  }

  /* Accuse overlay */
  #accuseOverlay{
    position:absolute;
    inset:0;
    background:rgba(15,23,42,.85);
    display:none;
    justify-content:center;
    align-items:center;
  }
  #accuseOverlay.active{
    display:flex;
  }
  .accuse-panel{
    width:420px;
    padding:18px 20px;
    background:rgba(15,23,42,.98);
    border-radius:18px;
    border:1px solid rgba(148,163,184,.8);
    box-shadow:0 24px 100px rgba(0,0,0,.9);
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .accuse-title{
    font-size:.9rem;
    letter-spacing:.18em;
    text-transform:uppercase;
    color:rgba(148,163,184,.9);
  }
  .accuse-row{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .accuse-btn{
    padding:8px 12px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.7);
    background:#020617;
    color:#e5e7eb;
    text-align:left;
    cursor:pointer;
    transition:.15s;
  }
  .accuse-btn:hover{
    background:#111827;
  }
  .accuse-footer{
    display:flex;
    justify-content:flex-end;
  }
  .ghost-btn{
    background:transparent;
    border:none;
    color:rgba(148,163,184,.85);
    font-size:.8rem;
    cursor:pointer;
  }
</style>
</head>
<body>
<div class="game">
  <canvas id="detective"></canvas>
  <canvas id="suspect"></canvas>

  <div id="topLeftButtons">
    <button class="small-btn" id="briefBtn">Brief</button>
    <button class="small-btn" id="copBtn">Ask Wren</button>
  </div>

  <!-- suspect tabs + accuse + next-case in one bar -->
  <div id="suspectTabs">
    <div id="suspectTabsInner"></div>
    <button id="accuseBtn" disabled>Accuse</button>
    <button id="nextCaseBtn">Next Case</button>
  </div>

  <div id="questions">
    <button class="question-btn" data-index="0">
      Where were you last night?
    </button>
    <button class="question-btn" data-index="1">
      Did you know the victim?
    </button>
    <button class="question-btn" data-index="2">
      Why are your fingerprints at the scene?
    </button>
  </div>

  <div class="dialogue-box" id="dialogBox">
    <div class="dialogue-label" id="speakerLabel">MR LAWSON</div>
    <div class="dialogue-text" id="answer">
      Loading case…
    </div>
  </div>

  <!-- Accuse overlay -->
  <div id="accuseOverlay">
    <div class="accuse-panel">
      <div class="accuse-title">WHO DO YOU ACCUSE?</div>
      <div class="accuse-row" id="accuseChoices"></div>
      <div class="accuse-footer">
        <button class="ghost-btn" id="cancelAccuse">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================== DETECTIVE SPRITE ================== */
const detImg = new Image();
detImg.src = "sprites/detective/Detectiveinterrogationsprite.png";
const DET_FRAMES = 4;
const DET_SHEET_W = 1200;
const DET_SHEET_H = 400;
const DET_FRAME_W = DET_SHEET_W / DET_FRAMES;
const DET_FRAME_H = DET_SHEET_H;
const DET_FPS = 6;

const detCanvas = document.getElementById("detective");
const detCtx = detCanvas.getContext("2d");
detCanvas.width = DET_FRAME_W;
detCanvas.height = DET_FRAME_H;

let detFrame = 0;
let detLast = 0;

/* ================== MASTER SUSPECT DATA ================== */
const suspects = {
  lawson: {
    key: "lawson",
    displayName: "MR LAWSON",
    idleSrc: "sprites/suspects/mr_lawson_idle.png",
    talkSrc: "sprites/suspects/mr_lawson_talk.png",
    idleFrames: 13,
    talkFrames: 19,
    scale: 1.0,
    defaultAnswers: [
      "I was at home… reading. Alone. No witnesses. Convenient, I know.",
      "The victim? I'd seen them around the office. That's it. We weren't… close.",
      "My prints? I handled the briefcase once. Weeks ago. If they’re still there, that’s your forensics department, not me."
    ]
  },
  zoe: {
    key: "zoe",
    displayName: "ZOE",
    idleSrc: "sprites/suspects/zoe_idle.png",
    talkSrc: "sprites/suspects/zoe_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "Last night? I was closing up the café. You can ask anyone on the late shift.",
      "I knew them as a regular. Black coffee, no sugar, always a crossword.",
      "If my prints are there, it’s because I handed them their drink—or wiped the table."
    ]
  },
  lindsay: {
    key: "lindsay",
    displayName: "LINDSAY",
    idleSrc: "sprites/suspects/lindsay_idle.png",
    talkSrc: "sprites/suspects/lindsay_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I was working late at the gallery, inventory checks.",
      "We crossed paths at functions. Polite smiles only.",
      "Those fingerprints? The briefcase used to be stored at the gallery. I moved it months ago."
    ]
  },
  carol: {
    key: "carol",
    displayName: "CAROL",
    idleSrc: "sprites/suspects/carol_idle.png",
    talkSrc: "sprites/suspects/carol_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I left the records office at eight, same as always.",
      "We only met when he came begging for old paperwork.",
      "My fingerprints are on half the crates in that building."
    ]
  },
  ben: {
    key: "ben",
    displayName: "BEN",
    idleSrc: "sprites/suspects/ben_idle.png",
    talkSrc: "sprites/suspects/ben_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "Night shift again. I pushed the crates to the service lift like I always do.",
      "He was just the name on the manifest.",
      "Those prints? I hauled that crate with both hands."
    ]
  },
  veronica: {
    key: "veronica",
    displayName: "VERONICA",
    idleSrc: "sprites/suspects/veronica_idle.png",
    talkSrc: "sprites/suspects/veronica_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I floated between conversations, smiling until my jaw ached.",
      "He backed my show at the last minute when everyone else pulled out.",
      "If my fingerprints are on his drink, it is because he insisted we toast."
    ]
  },
  issac: {
    key: "issac",
    displayName: "ISSAC",
    idleSrc: "sprites/suspects/issac_idle.png",
    talkSrc: "sprites/suspects/issac_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I was alone here, tuning the generator.",
      "He came to me for advice on his numbers.",
      "My fingerprints cover every tool in this room."
    ]
  },
  darren: {
    key: "darren",
    displayName: "DARREN",
    idleSrc: "sprites/suspects/darren_idle.png",
    talkSrc: "sprites/suspects/darren_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "Bar was full when the lights dipped.",
      "He drank here sometimes, alone in a corner.",
      "If my prints made it next door, it is because I help Issac drag spare kegs."
    ]
  },
  chris: {
    key: "chris",
    displayName: "CHRIS",
    idleSrc: "sprites/suspects/chris_idle.png",
    talkSrc: "sprites/suspects/chris_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I walked the usual route.",
      "I knew him as 'the man with the briefcase'.",
      "My fingerprints on the workshop door are from earlier that week."
    ]
  },
  peter: {
    key: "peter",
    displayName: "PETER",
    idleSrc: "sprites/suspects/peter_idle.png",
    talkSrc: "sprites/suspects/peter_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I inspected the generators along the riverwalk.",
      "We met twice; he refused to pay an emergency call-out fee.",
      "If my prints are on that bench, it is because I sat down to smoke."
    ]
  },
  emma: {
    key: "emma",
    displayName: "EMMA",
    idleSrc: "sprites/suspects/emma_idle.png",
    talkSrc: "sprites/suspects/emma_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I spent the evening balancing books at home.",
      "He trusted me with his companies because I made the money look clean.",
      "The only reason my prints would be near that bench is if I ever met him there to pass documents."
    ]
  }
};

for (const key in suspects){
  suspects[key].currentAnswers = suspects[key].defaultAnswers.slice();
}

/* ================== WREN SPRITE ================== */

const wrenImg = new Image();
wrenImg.src = "sprites/suspects/wren_idle.png";
const WREN_FRAMES = 8;
const WREN_SCALE = 1.0;

let wrenFrame = 0;
let wrenLast = 0;

/* ================== RIGHT-SIDE CANVAS ================== */

const susCanvas = document.getElementById("suspect");
const susCtx = susCanvas.getContext("2d");

let susMaxW = 0;
let susMaxH = 0;

function loadSpriteImages(){
  for (const key in suspects){
    const s = suspects[key];

    s.idleImg = new Image();
    s.idleImg.src = s.idleSrc;
    s.idleImg.onload = updateRightCanvasSize;

    s.talkImg = new Image();
    s.talkImg.src = s.talkSrc;
    s.talkImg.onload = updateRightCanvasSize;
  }
  wrenImg.onload = updateRightCanvasSize;
}
loadSpriteImages();

function updateRightCanvasSize(){
  let w = 0, h = 0;
  for (const key in suspects){
    const s = suspects[key];

    if (s.idleImg.complete && s.idleImg.width){
      const fw = s.idleImg.width / s.idleFrames;
      const fh = s.idleImg.height;
      w = Math.max(w, fw * s.scale);
      h = Math.max(h, fh * s.scale);
    }
    if (s.talkImg.complete && s.talkImg.width){
      const fw = s.talkImg.width / s.talkFrames;
      const fh = s.talkImg.height;
      w = Math.max(w, fw * s.scale);
      h = Math.max(h, fh * s.scale);
    }
  }
  if (wrenImg.complete && wrenImg.width){
    const fw = wrenImg.width / WREN_FRAMES;
    const fh = wrenImg.height;
    w = Math.max(w, fw * WREN_SCALE);
    h = Math.max(h, fh * WREN_SCALE);
  }

  if (w && h){
    susMaxW = w;
    susMaxH = h;
    susCanvas.width = susMaxW;
    susCanvas.height = susMaxH;
  }
}

/* viewMode: 'suspect' or 'wren' */
let viewMode = "suspect";

/* current suspect & state */
let currentSuspectKey = "lawson";
const suspectState = {
  state: "idle",
  frame: 0,
  last: 0
};

/* ================== TEXT & UI ================== */

const speakerLabel = document.getElementById("speakerLabel");
const answerEl = document.getElementById("answer");
const questionButtons = Array.from(document.querySelectorAll(".question-btn"));
const suspectTabsInner = document.getElementById("suspectTabsInner");
const briefBtn = document.getElementById("briefBtn");
const copBtn = document.getElementById("copBtn");
const accuseBtn = document.getElementById("accuseBtn");
const nextCaseBtn = document.getElementById("nextCaseBtn");
const accuseOverlay = document.getElementById("accuseOverlay");
const accuseChoices = document.getElementById("accuseChoices");
const cancelAccuse = document.getElementById("cancelAccuse");

let suspectTabs = [];
let typingTimer = null;
let typingText = "";
let typingIndex = 0;
let anyQuestionAsked = false;
let caseClosed = false;

/* ====== CASE LOADER STATE ====== */

const DEFAULT_CASE = {
  id: 0,
  title: "Default Case – Late Office",
  culprit: "lindsay",
  brief:
    "A financier is found dead in his office late at night.\n\n" +
    "• A shattered coffee cup near the desk.\n" +
    "• A briefcase moved from its usual spot.\n" +
    "• Security cameras mysteriously disabled for a 20-minute window.\n\n" +
    "Everyone in this room touched the scene in some way. Your job is to decide whose story doesn’t hold.",
  wrenHint:
    "Look, detective, here’s what bothers me:\n\n" +
    "• The cameras die exactly when the briefcase is moved.\n" +
    "• Lawson’s alibi has no witnesses.\n" +
    "• Zoe and Lindsay both have ‘work’ reasons to be there, but only one of them had control over security.\n\n" +
    "My money? Follow whoever had access to both the gallery storage and the office locks.",
  suspects: ["lawson", "zoe", "lindsay"],
  answers: {},
  successEnding:
    "{culprit} folds as you lay out the contradictions.\n\n" +
    "The camera blackout, the briefcase being moved, and the mismatched alibis all point the same way.\n\n" +
    "You were right. The others walk—for now.",
  failureEnding:
    "You accuse {accused}. They protest, but the circumstantial evidence is enough for an arrest… for the moment.\n\n" +
    "Later, WREN calls. Forensics and access logs quietly clear {accused} — and point back toward {culprit}.\n\n" +
    "You got someone into cuffs, but not the right one. This city’s not done with you."
};

let currentBrief = DEFAULT_CASE.brief;
let currentWrenHint = DEFAULT_CASE.wrenHint;
let culpritKey = DEFAULT_CASE.culprit;
let activeSuspects = DEFAULT_CASE.suspects.slice();
let currentSuccessEnding = DEFAULT_CASE.successEnding;
let currentFailureEnding = DEFAULT_CASE.failureEnding;
let currentCaseIndex = 1;
const MAX_CASES = 10;

function formatEnding(template, { culprit, accused }){
  if (!template) return "";
  return template
    .replaceAll("{culprit}", culprit.displayName)
    .replaceAll("{accused}", accused.displayName);
}

/* ================== MAIN LOOP ================== */

function mainLoop(timestamp){
  drawDetective(timestamp);
  drawRightSide(timestamp);
  requestAnimationFrame(mainLoop);
}
requestAnimationFrame(mainLoop);

function drawDetective(t){
  if (!detImg.complete) return;
  if (!detLast) detLast = t;
  if (t - detLast >= 1000 / DET_FPS){
    detFrame = (detFrame + 1) % DET_FRAMES;
    detLast = t;
  }
  detCtx.clearRect(0,0,detCanvas.width,detCanvas.height);
  detCtx.drawImage(
    detImg,
    detFrame * DET_FRAME_W, 0, DET_FRAME_W, DET_FRAME_H,
    0, 0, DET_FRAME_W, DET_FRAME_H
  );
}

function drawRightSide(t){
  if (viewMode === "wren"){
    if (!wrenImg.complete || !wrenImg.width) return;

    if (!wrenLast) wrenLast = t;
    if (t - wrenLast >= 1000 / 8){
      wrenFrame = (wrenFrame + 1) % WREN_FRAMES;
      wrenLast = t;
    }

    const frameW = wrenImg.width / WREN_FRAMES;
    const frameH = wrenImg.height;
    const destW = frameW * WREN_SCALE;
    const destH = frameH * WREN_SCALE;

    const dx = (susCanvas.width - destW) / 2;
    const dy = susCanvas.height - destH;

    susCtx.clearRect(0,0,susCanvas.width,susCanvas.height);
    susCtx.drawImage(
      wrenImg,
      wrenFrame * frameW, 0, frameW, frameH,
      dx, dy, destW, destH
    );
  } else {
    const s = suspects[currentSuspectKey];
    const img = suspectState.state === "talk" ? s.talkImg : s.idleImg;
    const frames = suspectState.state === "talk" ? s.talkFrames : s.idleFrames;
    const scale = s.scale;

    if (!img.complete || !img.width) return;

    if (!suspectState.last) suspectState.last = t;
    if (t - suspectState.last >= 1000 / 8){
      suspectState.frame = (suspectState.frame + 1) % frames;
      suspectState.last = t;
    }

    const frameW = img.width / frames;
    const frameH = img.height;
    const destW = frameW * scale;
    const destH = frameH * scale;

    const dx = (susCanvas.width - destW) / 2;
    const dy = susCanvas.height - destH;

    susCtx.clearRect(0,0,susCanvas.width,susCanvas.height);
    susCtx.drawImage(
      img,
      suspectState.frame * frameW, 0, frameW, frameH,
      dx, dy, destW, destH
    );
  }
}

/* ================== INTERACTION ================== */

questionButtons.forEach(btn=>{
  btn.addEventListener("click", () => {
    if (caseClosed) return;
    const index = parseInt(btn.dataset.index,10);
    if (btn.disabled) return;

    viewMode = "suspect";

    anyQuestionAsked = true;
    accuseBtn.disabled = false;

    if (!detCanvas.classList.contains("visible")){
      detCanvas.classList.add("visible");
    }

    btn.disabled = true;
    btn.classList.add("used");
    playAnswer(index);
  });
});

function playAnswer(index){
  const s = suspects[currentSuspectKey];
  const arr = s.currentAnswers || s.defaultAnswers || [];
  const text = arr[index] || "…";
  startTyping(text, s.displayName);
}

function startTyping(text, speakerName){
  speakerLabel.textContent = speakerName;
  if (viewMode === "suspect"){
    suspectState.state = "talk";
    suspectState.frame = 0;
    suspectState.last = 0;
  }

  if (typingTimer) clearTimeout(typingTimer);
  typingText = text;
  typingIndex = 0;
  answerEl.textContent = "";
  typeStep();
}

function typeStep(){
  answerEl.textContent = typingText.slice(0, typingIndex);
  typingIndex++;
  if (typingIndex <= typingText.length){
    typingTimer = setTimeout(typeStep, 25);
  } else {
    typingTimer = setTimeout(()=>{
      if (viewMode === "suspect"){
        suspectState.state = "idle";
        suspectState.frame = 0;
      }
    }, 250);
  }
}

/* ====== Question reset & suspect switching ====== */

function resetQuestions(){
  questionButtons.forEach(btn=>{
    btn.disabled = false;
    btn.classList.remove("used");
  });
}

function setCurrentSuspect(key){
  if (!suspects[key]) return;
  currentSuspectKey = key;
  const s = suspects[key];
  viewMode = "suspect";
  speakerLabel.textContent = s.displayName;
  answerEl.textContent = `Interviewing ${s.displayName}. Choose a question.`;
  suspectState.state = "idle";
  suspectState.frame = 0;
  suspectState.last = 0;

  suspectTabs.forEach(tab=>{
    tab.classList.toggle("active", tab.dataset.suspect === key);
  });
}

function renderSuspectTabs(){
  suspectTabsInner.innerHTML = "";
  suspectTabs = [];

  activeSuspects.forEach(key=>{
    const s = suspects[key];
    if (!s) return;
    const btn = document.createElement("button");
    btn.className = "suspect-tab";
    btn.dataset.suspect = key;
    btn.textContent = s.displayName;
    btn.addEventListener("click", ()=>{
      if (caseClosed) return;
      if (key !== currentSuspectKey){
        resetQuestions();
        setCurrentSuspect(key);
      }
    });
    suspectTabsInner.appendChild(btn);
    suspectTabs.push(btn);
  });
}

/* ====== Brief & Wren hint ====== */

briefBtn.addEventListener("click", ()=>{
  if (caseClosed) return;
  viewMode = "suspect";
  speakerLabel.textContent = "CASE BRIEF";
  if (typingTimer) clearTimeout(typingTimer);
  typingText = currentBrief;
  typingIndex = 0;
  typeStep();
});

copBtn.addEventListener("click", ()=>{
  if (caseClosed) return;
  viewMode = "wren";
  speakerLabel.textContent = "DETECTIVE WREN";
  if (typingTimer) clearTimeout(typingTimer);
  typingText = currentWrenHint;
  typingIndex = 0;
  typeStep();
});

/* ====== Accuse flow ====== */

accuseBtn.addEventListener("click", ()=>{
  if (caseClosed) return;
  if (!anyQuestionAsked) return;
  openAccuseOverlay();
});

function openAccuseOverlay(){
  accuseChoices.innerHTML = "";
  activeSuspects.forEach(key=>{
    const s = suspects[key];
    const b = document.createElement("button");
    b.className = "accuse-btn";
    b.textContent = s.displayName;
    b.addEventListener("click", ()=>resolveAccusation(key));
    accuseChoices.appendChild(b);
  });
  accuseOverlay.classList.add("active");
}

cancelAccuse.addEventListener("click", ()=>{
  accuseOverlay.classList.remove("active");
});

function resolveAccusation(key){
  accuseOverlay.classList.remove("active");
  caseClosed = true;
  accuseBtn.disabled = true;
  nextCaseBtn.style.display = "inline-block";
  resetQuestions();
  questionButtons.forEach(btn=>btn.disabled = true);

  viewMode = "suspect";

  const accused = suspects[key];
  const culprit = suspects[culpritKey];

  if (key === culpritKey){
    speakerLabel.textContent = "CASE CLOSED";
    const templ = currentSuccessEnding || DEFAULT_CASE.successEnding;
    answerEl.textContent = formatEnding(templ, { culprit, accused });
  } else {
    speakerLabel.textContent = "CASE PARTIALLY SOLVED";
    const templ = currentFailureEnding || DEFAULT_CASE.failureEnding;
    answerEl.textContent = formatEnding(templ, { culprit, accused });
  }
}

/* ====== Next case & loader ====== */

nextCaseBtn.addEventListener("click", ()=>{
  currentCaseIndex++;
  if (currentCaseIndex > MAX_CASES){
    currentCaseIndex = 1;
  }
  loadCase(currentCaseIndex);
});

function applyCaseToSuspects(caseData){
  for (const key in suspects){
    suspects[key].currentAnswers = suspects[key].defaultAnswers.slice();
  }
  if (caseData.answers){
    for (const key in caseData.answers){
      if (suspects[key]){
        suspects[key].currentAnswers = caseData.answers[key];
      }
    }
  }
}

function inferActiveSuspects(caseData){
  if (Array.isArray(caseData.suspects) && caseData.suspects.length){
    return caseData.suspects.filter(k => suspects[k]);
  }
  const inferred = new Set();
  if (caseData.culprit && suspects[caseData.culprit]) inferred.add(caseData.culprit);
  if (caseData.answers){
    Object.keys(caseData.answers).forEach(k=>{
      if (suspects[k]) inferred.add(k);
    });
  }
  if (!inferred.size){
    DEFAULT_CASE.suspects.forEach(k=>inferred.add(k));
  }
  return Array.from(inferred);
}

async function loadCase(index){
  caseClosed = false;
  anyQuestionAsked = false;
  accuseBtn.disabled = true;
  nextCaseBtn.style.display = "none";
  detCanvas.classList.remove("visible");
  resetQuestions();

  const path = `cases/case${index}.json`;
  try{
    const res = await fetch(path);
    if (!res.ok) throw new Error(res.statusText);
    const data = await res.json();

    culpritKey = data.culprit || DEFAULT_CASE.culprit;
    currentBrief = data.brief || DEFAULT_CASE.brief;
    currentWrenHint = data.wrenHint || DEFAULT_CASE.wrenHint;
    currentSuccessEnding = data.successEnding || DEFAULT_CASE.successEnding;
    currentFailureEnding = data.failureEnding || DEFAULT_CASE.failureEnding;

    applyCaseToSuspects(data);
    activeSuspects = inferActiveSuspects(data);
    renderSuspectTabs();
    setCurrentSuspect(activeSuspects[0] || "lawson");

    speakerLabel.textContent = `CASE ${data.id || index}`;
    answerEl.textContent = data.title || "New case loaded. Choose a suspect.";

  }catch(err){
    culpritKey = DEFAULT_CASE.culprit;
    currentBrief = DEFAULT_CASE.brief;
    currentWrenHint = DEFAULT_CASE.wrenHint;
    currentSuccessEnding = DEFAULT_CASE.successEnding;
    currentFailureEnding = DEFAULT_CASE.failureEnding;

    applyCaseToSuspects(DEFAULT_CASE);
    activeSuspects = DEFAULT_CASE.suspects.slice();
    renderSuspectTabs();
    setCurrentSuspect(activeSuspects[0]);

    speakerLabel.textContent = "CASE LOADER";
    answerEl.textContent =
      `Couldn't load ${path}.\n\nUsing built-in default case instead.`;
  }
}

/* init */
activeSuspects = DEFAULT_CASE.suspects.slice();
renderSuspectTabs();
setCurrentSuspect("lawson");
loadCase(currentCaseIndex);
</script>
</body>
</html>
