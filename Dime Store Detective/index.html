<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Detective Interrogation â€“ Case One</title>

<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  body{
    height:100vh;
    background:#050814;
    color:#e5e7eb;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    display:flex;
    justify-content:center;
    align-items:center;
    overflow:hidden;
  }

  .game{
    width:1100px;
    height:650px;
    position:relative;
    background:radial-gradient(circle at 20% 10%, #1f2937 0, #020617 55%);
    box-shadow:0 40px 120px rgba(0,0,0,.9);
    border-radius:18px;
    border:1px solid rgba(148,163,184,.35);
  }

  /* Detective canvas (left) */
  #detective{
    position:absolute;
    top:160px;
    left:-360px; /* off-screen start */
    width:300px;
    height:400px;
    image-rendering:pixelated;
    transition:left .7s ease-out, opacity .7s ease-out;
    filter:drop-shadow(0 0 24px #000a);
    opacity:0;              /* hidden at start */
  }
  #detective.visible{
    left:60px;
    opacity:1;              /* fades / slides in */
  }

  /* Right-side canvas (suspect OR Wren) */
  #suspect{
    position:absolute;
    top:80px;
    right:40px;
    image-rendering:pixelated;
    filter:drop-shadow(0 0 24px #000a);
  }

  /* Top controls */
  #suspectTabs{
    position:absolute;
    top:32px;
    right:160px;
    display:none; /* HIDDEN so players only use Directory */
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-end;
    max-width:50%;
  }
  .suspect-tab{
    padding:6px 12px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.9);
    color:#e5e7eb;
    font-size:.8rem;
    letter-spacing:.08em;
    text-transform:uppercase;
    cursor:pointer;
    opacity:.6;
    transition:.15s;
  }
  .suspect-tab:hover{
    opacity:.9;
    background:#111827;
  }
  .suspect-tab.active{
    opacity:1;
    background:#1e293b;
    border-color:rgba(148,163,184,.9);
  }

  #topLeftButtons{
    position:absolute;
    top:32px;
    left:40px;
    display:flex;
    gap:8px;
    align-items:center;
  }
  .small-btn{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.9);
    color:#e5e7eb;
    font-size:.78rem;
    letter-spacing:.06em;
    text-transform:uppercase;
    cursor:pointer;
    opacity:.8;
    transition:.15s;
  }
  .small-btn:hover{
    opacity:1;
    background:#111827;
  }

  /* Question list */
  #questions{
    position:absolute;
    left:260px;
    right:400px;
    bottom:220px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .question-btn{
    padding:9px 12px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.45);
    background:rgba(15,23,42,.9);
    color:#e5e7eb;
    text-align:left;
    font-size:.95rem;
    cursor:pointer;
    backdrop-filter:blur(10px);
    transition:background .15s, transform .05s;
  }
  .question-btn:hover:not(.used):not(:disabled){
    background:#111827;
    transform:translateY(-1px);
  }
  .question-btn.used,
  .question-btn:disabled{
    opacity:.35;
    cursor:default;
  }

  /* Dialogue box (answer) */
  .dialogue-box{
    position:absolute;
    left:220px;
    right:220px;
    bottom:40px;
    min-height:110px;
    padding:14px 18px;
    background:rgba(15,23,42,.92);
    border-radius:14px;
    border:1px solid rgba(51,65,85,.8);
    backdrop-filter:blur(16px);
    box-shadow:0 18px 60px rgba(0,0,0,.8);
    font-size:1.02rem;
    line-height:1.4rem;
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .dialogue-label{
    font-size:.8rem;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:rgba(148,163,184,.9);
  }
  .dialogue-text{
    white-space:pre-wrap;
  }

  /* Accuse + Next Case buttons */
  #accuseBtn{
    position:absolute;
    top:28px;
    right:40px;
    padding:8px 16px;
    border-radius:999px;
    border:1px solid rgba(248,113,113,.8);
    background:rgba(127,29,29,.9);
    color:#fee2e2;
    font-size:.8rem;
    letter-spacing:.08em;
    text-transform:uppercase;
    cursor:pointer;
    transition:.15s;
  }
  #accuseBtn:hover:not(:disabled){
    background:#b91c1c;
  }
  #accuseBtn:disabled{
    opacity:.4;
    cursor:default;
  }

  #nextCaseBtn{
    position:absolute;
    top:70px;
    right:40px;
    padding:8px 14px;
    border-radius:999px;
    border:1px solid rgba(52,211,153,.8);
    background:rgba(6,95,70,.95);
    color:#ecfdf5;
    font-size:.8rem;
    letter-spacing:.08em;
    text-transform:uppercase;
    cursor:pointer;
    transition:.15s;
    display:none;
  }
  #nextCaseBtn:hover{
    background:#047857;
  }

  /* Accuse overlay */
  #accuseOverlay{
    position:absolute;
    inset:0;
    background:rgba(15,23,42,.85);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:20;
  }
  #accuseOverlay.active{
    display:flex;
  }
  .accuse-panel{
    width:420px;
    padding:18px 20px;
    background:rgba(15,23,42,.98);
    border-radius:18px;
    border:1px solid rgba(148,163,184,.8);
    box-shadow:0 24px 100px rgba(0,0,0,.9);
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .accuse-title{
    font-size:.9rem;
    letter-spacing:.18em;
    text-transform:uppercase;
    color:rgba(148,163,184,.9);
  }
  .accuse-row{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .accuse-btn{
    padding:8px 12px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.7);
    background:#020617;
    color:#e5e7eb;
    text-align:left;
    cursor:pointer;
    transition:.15s;
  }
  .accuse-btn:hover{
    background:#111827;
  }
  .accuse-footer{
    display:flex;
    justify-content:flex-end;
  }
  .ghost-btn{
    background:transparent;
    border:none;
    color:rgba(148,163,184,.85);
    font-size:.8rem;
    cursor:pointer;
  }

  /* ================= DIRECTORY OVERLAY ================= */

  #directoryOverlay{
    position:absolute;
    inset:0;
    background:linear-gradient(to bottom, rgba(15,23,42,.96), rgba(15,23,42,.92));
    display:none;
    flex-direction:column;
    padding:28px 40px;
    z-index:15;
  }
  #directoryOverlay.active{
    display:flex;
  }

  .directory-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
  }
  .directory-title{
    font-size:.9rem;
    letter-spacing:.18em;
    text-transform:uppercase;
    color:rgba(148,163,184,.95);
  }
  .directory-close{
    background:transparent;
    border:none;
    color:rgba(148,163,184,.85);
    font-size:.8rem;
    cursor:pointer;
  }

  .directory-grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:12px 18px;
    overflow-y:auto;
  }

  .directory-card{
    display:flex;
    gap:10px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(51,65,85,.9);
    background:radial-gradient(circle at 0 0, rgba(148,163,184,.12), rgba(15,23,42,.98));
  }

  .directory-avatar{
    width:40px;
    height:40px;
    border-radius:8px;
    background:rgba(15,23,42,.9);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:.75rem;
    letter-spacing:.08em;
    text-transform:uppercase;
    border:1px solid rgba(148,163,184,.5);
  }

  .directory-main{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .directory-name{
    font-size:.82rem;
    letter-spacing:.12em;
    text-transform:uppercase;
  }
  .directory-job{
    font-size:.76rem;
    color:rgba(148,163,184,.95);
  }
  .directory-loc{
    font-size:.72rem;
    color:rgba(148,163,184,.8);
  }
  .directory-tagline{
    font-size:.75rem;
    color:rgba(209,213,219,.95);
    margin-top:2px;
  }

  .directory-status{
    margin-top:4px;
    font-size:.7rem;
    display:inline-flex;
    align-items:center;
    gap:6px;
    color:rgba(148,163,184,.9);
  }
  .directory-status-pill{
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.5);
    font-size:.66rem;
    text-transform:uppercase;
    letter-spacing:.08em;
    background:rgba(15,23,42,.9);
  }

  .directory-footer-row{
    margin-top:4px;
    display:flex;
    justify-content:flex-end;
  }
  .directory-interview{
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.7);
    background:#020617;
    color:#e5e7eb;
    font-size:.7rem;
    letter-spacing:.08em;
    text-transform:uppercase;
    cursor:pointer;
  }
  .directory-interview:hover{
    background:#111827;
  }

</style>
</head>
<body>
<div class="game">
  <canvas id="detective"></canvas>
  <canvas id="suspect"></canvas>

  <div id="topLeftButtons">
    <button class="small-btn" id="briefBtn">Brief</button>
    <button class="small-btn" id="copBtn">Ask Wren</button>
    <button class="small-btn" id="directoryBtn">Directory</button>
  </div>

  <!-- suspect tabs (now hidden via CSS but kept for future if needed) -->
  <div id="suspectTabs"></div>

  <div id="questions">
    <button class="question-btn" data-index="0">
      Where were you last night?
    </button>
    <button class="question-btn" data-index="1">
      Did you know the victim?
    </button>
    <button class="question-btn" data-index="2">
      Why are your fingerprints at the scene?
    </button>
  </div>

  <button id="accuseBtn" disabled>Accuse</button>
  <button id="nextCaseBtn">Next Case</button>

  <div class="dialogue-box" id="dialogBox">
    <div class="dialogue-label" id="speakerLabel">MR LAWSON</div>
    <div class="dialogue-text" id="answer">
      Loading caseâ€¦
    </div>
  </div>

  <!-- Accuse overlay -->
  <div id="accuseOverlay">
    <div class="accuse-panel">
      <div class="accuse-title">WHO DO YOU ACCUSE?</div>
      <div class="accuse-row" id="accuseChoices"></div>
      <div class="accuse-footer">
        <button class="ghost-btn" id="cancelAccuse">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Directory overlay -->
  <div id="directoryOverlay">
    <div class="directory-header">
      <div class="directory-title">CITY DIRECTORY â€“ CURRENT CASE</div>
      <button class="directory-close" id="directoryClose">Close</button>
    </div>
    <div class="directory-grid" id="directoryGrid">
      <!-- entries populated via JS -->
    </div>
  </div>

</div>

<script>
/* ================== DETECTIVE SPRITE ================== */
const detImg = new Image();
detImg.src = "sprites/detective/Detectiveinterrogationsprite.png";
const DET_FRAMES = 4;
const DET_SHEET_W = 1200;
const DET_SHEET_H = 400;
const DET_FRAME_W = DET_SHEET_W / DET_FRAMES;
const DET_FRAME_H = DET_SHEET_H;
const DET_FPS = 6;

const detCanvas = document.getElementById("detective");
const detCtx = detCanvas.getContext("2d");
detCanvas.width = DET_FRAME_W;
detCanvas.height = DET_FRAME_H;

let detFrame = 0;
let detLast = 0;

/* ================== MASTER CITY ROSTER ================== */
/* sprite paths are relative to this HTML file */
const suspects = {
  lawson: {
    key: "lawson",
    displayName: "MR LAWSON",
    job: "Corporate Lawyer",
    location: "Riverside Offices, 12th Floor",
    tagline: "Keeps bad numbers looking respectable.",
    idleSrc: "sprites/suspects/mr_lawson_idle.png",
    talkSrc: "sprites/suspects/mr_lawson_talk.png",
    idleFrames: 13,
    talkFrames: 19,
    scale: 1.0,
    defaultAnswers: [
      "I was at homeâ€¦ reading. Alone. No witnesses. Convenient, I know.",
      "The victim? I'd seen them around the office. That's it. We weren'tâ€¦ close.",
      "My prints? I handled the briefcase once. Weeks ago. If theyâ€™re still there, thatâ€™s your forensics department, not me."
    ]
  },
  zoe: {
    key: "zoe",
    displayName: "ZOE",
    job: "CafÃ© Owner & Barista",
    location: "Ground-Floor CafÃ©, Tower Lobby",
    tagline: "Knows every coffee order and half the cityâ€™s gossip.",
    idleSrc: "sprites/suspects/zoe_idle.png",
    talkSrc: "sprites/suspects/zoe_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "Last night? I was closing up the cafÃ©. You can ask anyone on the late shift.",
      "I knew them as a regular. Black coffee, no sugar, always a crossword.",
      "If my prints are there, itâ€™s because I handed them their drinkâ€”or wiped the table."
    ]
  },
  lindsay: {
    key: "lindsay",
    displayName: "LINDSAY",
    job: "Gallery Curator",
    location: "Lindsay & Co. Modern Gallery",
    tagline: "Hangs other peopleâ€™s fortunes on the wall.",
    idleSrc: "sprites/suspects/lindsay_idle.png",
    talkSrc: "sprites/suspects/lindsay_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I was working late at the gallery, inventory checks.",
      "We crossed paths at functions. Polite smiles only.",
      "Those fingerprints? The briefcase used to be stored at the gallery. I moved it months ago."
    ]
  },
  carol: {
    key: "carol",
    displayName: "CAROL",
    job: "Records Clerk",
    location: "Municipal Archives, Basement Level",
    tagline: "Guardian of paperwork the city wishes it had lost.",
    idleSrc: "sprites/suspects/carol_idle.png",
    talkSrc: "sprites/suspects/carol_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I left the records office at eight, same as always.",
      "We only met when he came begging for old paperwork.",
      "My fingerprints are on half the crates in that building."
    ]
  },
  ben: {
    key: "ben",
    displayName: "BEN",
    job: "Night-Shift Porter",
    location: "Tower Loading Bay",
    tagline: "Moves crates, hears secrets, gets ignored.",
    idleSrc: "sprites/suspects/ben_idle.png",
    talkSrc: "sprites/suspects/ben_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "Night shift, same as always. Unloaded two crates, trolleyed them to the service lift like I always do.",
      "He was just the name on the manifest.",
      "Those prints? I hauled that crate with both hands."
    ]
  },
  veronica: {
    key: "veronica",
    displayName: "VERONICA",
    job: "Performance Artist",
    location: "Warehouse Studios by the River",
    tagline: "Lives for the spotlight, kills for a headline.",
    idleSrc: "sprites/suspects/veronica_idle.png",
    talkSrc: "sprites/suspects/veronica_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I floated between conversations, smiling until my jaw ached.",
      "He backed my show at the last minute when everyone else pulled out.",
      "If my fingerprints are on his drink, it is because he insisted we toast."
    ]
  },
  issac: {
    key: "issac",
    displayName: "ISSAC",
    job: "Electrical Engineer",
    location: "Back-Alley Workshop, Dockside",
    tagline: "Keeps the cityâ€™s lights on and its secrets humming.",
    idleSrc: "sprites/suspects/issac_idle.png",
    talkSrc: "sprites/suspects/issac_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I was alone here, tuning the generator.",
      "He came to me for advice on his numbers.",
      "My fingerprints cover every tool in this room."
    ]
  },
  darren: {
    key: "darren",
    displayName: "DARREN",
    job: "Bar Owner",
    location: "Darrenâ€™s Bar â€“ Alley Off 5th",
    tagline: "Pours drinks, hears confessions, remembers tabs.",
    idleSrc: "sprites/suspects/darren_idle.png",
    talkSrc: "sprites/suspects/darren_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "Bar was full when the lights dipped.",
      "He drank here sometimes, alone in a corner.",
      "If my prints made it next door, it is because I help Issac drag spare kegs."
    ]
  },
  chris: {
    key: "chris",
    displayName: "CHRIS",
    job: "Beat Cop",
    location: "Precinct 4, River District",
    tagline: "Walks the same streets every night, sees who repeats.",
    idleSrc: "sprites/suspects/chris_idle.png",
    talkSrc: "sprites/suspects/chris_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I walked the usual route.",
      "I knew him as 'the man with the briefcase'.",
      "My fingerprints on the workshop door are from earlier that week."
    ]
  },
  peter: {
    key: "peter",
    displayName: "PETER",
    job: "Maintenance Technician",
    location: "City Infrastructure Dept.",
    tagline: "Knows every boiler and back door in the district.",
    idleSrc: "sprites/suspects/peter_idle.png",
    talkSrc: "sprites/suspects/peter_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I inspected the generators along the riverwalk.",
      "We met twice; he refused to pay an emergency call-out fee.",
      "If my prints are on that bench, it is because I sat down to smoke."
    ]
  },
  emma: {
    key: "emma",
    displayName: "EMMA",
    job: "Forensic Accountant",
    location: "Small Office Above The Bank",
    tagline: "Makes crooked ledgers look straightâ€”until they crack.",
    idleSrc: "sprites/suspects/emma_idle.png",
    talkSrc: "sprites/suspects/emma_idle.png",
    idleFrames: 8,
    talkFrames: 8,
    scale: 1.0,
    defaultAnswers: [
      "I spent the evening balancing books at home.",
      "He trusted me with his companies because I made the money look clean.",
      "The only reason my prints would be near that bench is if I ever met him there to pass documents."
    ]
  }
};

const suspectKeys = Object.keys(suspects);

/* add currentAnswers by default */
for (const key in suspects){
  suspects[key].currentAnswers = suspects[key].defaultAnswers.slice();
}

/* ================== WREN SPRITE ================== */

const wrenImg = new Image();
wrenImg.src = "sprites/suspects/wren_idle.png";
const WREN_FRAMES = 8;
const WREN_SCALE = 1.0;

let wrenFrame = 0;
let wrenLast = 0;

/* ================== RIGHT-SIDE CANVAS ================== */

const susCanvas = document.getElementById("suspect");
const susCtx = susCanvas.getContext("2d");

let susMaxW = 0;
let susMaxH = 0;

function loadSpriteImages(){
  for (const key in suspects){
    const s = suspects[key];

    s.idleImg = new Image();
    s.idleImg.src = s.idleSrc;
    s.idleImg.onload = updateRightCanvasSize;

    s.talkImg = new Image();
    s.talkImg.src = s.talkSrc;
    s.talkImg.onload = updateRightCanvasSize;
  }
  wrenImg.onload = updateRightCanvasSize;
}
loadSpriteImages();

function updateRightCanvasSize(){
  let w = 0, h = 0;
  for (const key in suspects){
    const s = suspects[key];

    if (s.idleImg.complete && s.idleImg.width){
      const fw = s.idleImg.width / s.idleFrames;
      const fh = s.idleImg.height;
      w = Math.max(w, fw * s.scale);
      h = Math.max(h, fh * s.scale);
    }
    if (s.talkImg.complete && s.talkImg.width){
      const fw = s.talkImg.width / s.talkFrames;
      const fh = s.talkImg.height;
      w = Math.max(w, fw * s.scale);
      h = Math.max(h, fh * s.scale);
    }
  }
  if (wrenImg.complete && wrenImg.width){
    const fw = wrenImg.width / WREN_FRAMES;
    const fh = wrenImg.height;
    w = Math.max(w, fw * WREN_SCALE);
    h = Math.max(h, fh * WREN_SCALE);
  }

  if (w && h){
    susMaxW = w;
    susMaxH = h;
    susCanvas.width = susMaxW;
    susCanvas.height = susMaxH;
  }
}

/* viewMode: 'suspect' or 'wren' */
let viewMode = "suspect";

/* current suspect & state */
let currentSuspectKey = "lawson";
const suspectState = {
  state: "idle",   // 'idle' or 'talk'
  frame: 0,
  last: 0
};

/* ================== TEXT & UI ================== */

const speakerLabel   = document.getElementById("speakerLabel");
const answerEl       = document.getElementById("answer");
const questionButtons = Array.from(document.querySelectorAll(".question-btn"));
const suspectTabsContainer = document.getElementById("suspectTabs");
const briefBtn       = document.getElementById("briefBtn");
const copBtn         = document.getElementById("copBtn");
const accuseBtn      = document.getElementById("accuseBtn");
const nextCaseBtn    = document.getElementById("nextCaseBtn");
const accuseOverlay  = document.getElementById("accuseOverlay");
const accuseChoices  = document.getElementById("accuseChoices");
const cancelAccuse   = document.getElementById("cancelAccuse");

/* Directory UI */
const directoryBtn    = document.getElementById("directoryBtn");
const directoryOverlay = document.getElementById("directoryOverlay");
const directoryClose   = document.getElementById("directoryClose");
const directoryGrid    = document.getElementById("directoryGrid");

let suspectTabs = []; // buttons, built if we ever re-enable them

let typingTimer = null;
let typingText = "";
let typingIndex = 0;
let anyQuestionAsked = false;
let caseClosed = false;

/* ====== CASE LOADER STATE ====== */

const DEFAULT_CASE = {
  id: 0,
  title: "Default Case â€“ Late Office",
  culprit: "lindsay",
  brief:
    "A financier is found dead in his office late at night.\n\n" +
    "â€¢ A shattered coffee cup near the desk.\n" +
    "â€¢ A briefcase moved from its usual spot.\n" +
    "â€¢ Security cameras mysteriously disabled for a 20-minute window.\n\n" +
    "Everyone in this room touched the scene in some way. Your job is to decide whose story doesnâ€™t hold.",
  wrenHint:
    "Look, detective, hereâ€™s what bothers me:\n\n" +
    "â€¢ The cameras die exactly when the briefcase is moved.\n" +
    "â€¢ Lawsonâ€™s alibi has no witnesses.\n" +
    "â€¢ Zoe and Lindsay both have â€˜workâ€™ reasons to be there, but only one of them had control over security.\n\n" +
    "My money? Follow whoever had access to both the gallery storage and the office locks.",
  suspects: ["lawson", "zoe", "lindsay"],
  directory: ["lawson","zoe","lindsay"],
  answers: {},
  successEnding:
    "{culprit} folds as you lay out the contradictions.\n\n" +
    "The camera blackout, the briefcase being moved, and the mismatched alibis all point the same way.\n\n" +
    "You were right. The others walkâ€”for now.",
  failureEnding:
    "You accuse {accused}. They protest, but the circumstantial evidence is enough for an arrestâ€¦ for the moment.\n\n" +
    "Later, WREN calls. Forensics and access logs quietly clear {accused} â€” and point back toward {culprit}.\n\n" +
    "You got someone into cuffs, but not the right one. This cityâ€™s not done with you."
};

let currentBrief        = DEFAULT_CASE.brief;
let currentWrenHint     = DEFAULT_CASE.wrenHint;
let culpritKey          = DEFAULT_CASE.culprit;
let activeSuspects      = DEFAULT_CASE.suspects.slice();
let directoryPeople     = DEFAULT_CASE.directory.slice();
let currentSuccessEnding = DEFAULT_CASE.successEnding;
let currentFailureEnding = DEFAULT_CASE.failureEnding;
let currentCaseIndex    = 1;
const MAX_CASES         = 10;

/* ========== CHARACTERS.JSON LOADER ========== */

async function loadCharactersMeta(){
  try{
    const res = await fetch("characters.json");
    if (!res.ok) throw new Error(res.statusText);
    const data = await res.json();

    const chars = data.characters || data;

    for (const key in chars){
      if (!suspects[key]) continue;
      const c = chars[key];
      const s = suspects[key];

      if (c.name)  s.displayName = c.name;
      if (c.role)  s.job = c.role;
      if (c.status) s.status = c.status;
      if (c.arc)   s.arc = c.arc;
      if (Array.isArray(c.links))   s.links = c.links;
      if (Array.isArray(c.motives)) s.motives = c.motives;
      // location & tagline stay from this file for now unless you later add them to characters.json
    }
    console.log("characters.json loaded");
  }catch(err){
    console.warn("characters.json not loaded, using built-in meta only.", err);
  }
}

/* simple templating for endings */
function formatEnding(template, { culprit, accused }){
  if (!template) return "";
  return template
    .replaceAll("{culprit}", culprit.displayName)
    .replaceAll("{accused}", accused.displayName);
}

/* ================== MAIN LOOP ================== */

function mainLoop(timestamp){
  drawDetective(timestamp);
  drawRightSide(timestamp);
  requestAnimationFrame(mainLoop);
}
requestAnimationFrame(mainLoop);

function drawDetective(t){
  if (!detImg.complete) return;
  if (!detLast) detLast = t;
  if (t - detLast >= 1000 / DET_FPS){
    detFrame = (detFrame + 1) % DET_FRAMES;
    detLast = t;
  }
  detCtx.clearRect(0,0,detCanvas.width,detCanvas.height);
  detCtx.drawImage(
    detImg,
    detFrame * DET_FRAME_W, 0, DET_FRAME_W, DET_FRAME_H,
    0, 0, DET_FRAME_W, DET_FRAME_H
  );
}

/* Draw either suspect or Wren, depending on viewMode */
function drawRightSide(t){
  if (viewMode === "wren"){
    if (!wrenImg.complete || !wrenImg.width) return;

    if (!wrenLast) wrenLast = t;
    if (t - wrenLast >= 1000 / 8){
      wrenFrame = (wrenFrame + 1) % WREN_FRAMES;
      wrenLast = t;
    }

    const frameW = wrenImg.width / WREN_FRAMES;
    const frameH = wrenImg.height;
    const destW = frameW * WREN_SCALE;
    const destH = frameH * WREN_SCALE;

    const dx = (susCanvas.width - destW) / 2;
    const dy = susCanvas.height - destH;

    susCtx.clearRect(0,0,susCanvas.width,susCanvas.height);
    susCtx.drawImage(
      wrenImg,
      wrenFrame * frameW, 0, frameW, frameH,
      dx, dy, destW, destH
    );
  } else {
    const s = suspects[currentSuspectKey];
    const img = suspectState.state === "talk" ? s.talkImg : s.idleImg;
    const frames = suspectState.state === "talk" ? s.talkFrames : s.idleFrames;
    const scale = s.scale;

    if (!img.complete || !img.width) return;

    if (!suspectState.last) suspectState.last = t;
    if (t - suspectState.last >= 1000 / 8){
      suspectState.frame = (suspectState.frame + 1) % frames;
      suspectState.last = t;
    }

    const frameW = img.width / frames;
    const frameH = img.height;
    const destW = frameW * scale;
    const destH = frameH * scale;

    const dx = (susCanvas.width - destW) / 2;
    const dy = susCanvas.height - destH;

    susCtx.clearRect(0,0,susCanvas.width,susCanvas.height);
    susCtx.drawImage(
      img,
      suspectState.frame * frameW, 0, frameW, frameH,
      dx, dy, destW, destH
    );
  }
}

/* ================== INTERACTION ================== */

questionButtons.forEach(btn=>{
  btn.addEventListener("click", () => {
    if (caseClosed) return;
    const index = parseInt(btn.dataset.index,10);
    if (btn.disabled) return;

    viewMode = "suspect";

    anyQuestionAsked = true;
    accuseBtn.disabled = false;

    if (!detCanvas.classList.contains("visible")){
      detCanvas.classList.add("visible");
    }

    btn.disabled = true;
    btn.classList.add("used");
    playAnswer(index);
  });
});

function playAnswer(index){
  const s = suspects[currentSuspectKey];
  const arr = s.currentAnswers || s.defaultAnswers || [];
  const text = arr[index] || "â€¦";
  startTyping(text, s.displayName);
}

function startTyping(text, speakerName){
  speakerLabel.textContent = speakerName;
  if (viewMode === "suspect"){
    suspectState.state = "talk";
    suspectState.frame = 0;
    suspectState.last = 0;
  }

  if (typingTimer) clearTimeout(typingTimer);
  typingText = text;
  typingIndex = 0;
  answerEl.textContent = "";
  typeStep();
}

function typeStep(){
  answerEl.textContent = typingText.slice(0, typingIndex);
  typingIndex++;
  if (typingIndex <= typingText.length){
    typingTimer = setTimeout(typeStep, 25);
  } else {
    typingTimer = setTimeout(()=>{
      if (viewMode === "suspect"){
        suspectState.state = "idle";
        suspectState.frame = 0;
      }
    }, 250);
  }
}

/* ====== Question reset & suspect switching ====== */

function resetQuestions(){
  questionButtons.forEach(btn=>{
    btn.disabled = false;
    btn.classList.remove("used");
  });
}

function setCurrentSuspect(key){
  if (!suspects[key]) return;
  currentSuspectKey = key;
  const s = suspects[key];
  viewMode = "suspect";
  speakerLabel.textContent = s.displayName;
  answerEl.textContent = `Interviewing ${s.displayName}. Choose a question.`;
  suspectState.state = "idle";
  suspectState.frame = 0;
  suspectState.last = 0;

  suspectTabs.forEach(tab=>{
    tab.classList.toggle("active", tab.dataset.suspect === key);
  });
}

/* build suspect tabs for the *current case* only (even though hidden for now) */
function renderSuspectTabs(){
  suspectTabsContainer.innerHTML = "";
  suspectTabs = [];

  activeSuspects.forEach(key=>{
    const s = suspects[key];
    if (!s) return;
    const btn = document.createElement("button");
    btn.className = "suspect-tab";
    btn.dataset.suspect = key;
    btn.textContent = s.displayName;
    btn.addEventListener("click", ()=>{
      if (caseClosed) return;
      if (key !== currentSuspectKey){
        resetQuestions();
        setCurrentSuspect(key);
      }
    });
    suspectTabsContainer.appendChild(btn);
    suspectTabs.push(btn);
  });
}

/* ====== DIRECTORY RENDERING ====== */

function statusLabelFromCode(code){
  if (!code) return "Status unknown";

  if (code.startsWith("jailed_after_")) return "In custody";
  if (code.startsWith("fled_after_"))   return "Missing / fled";
  if (code === "mastermind")            return "Person of interest";
  if (code === "free")                  return "Active in city";
  return code.replace(/_/g," ");
}

function statusIconFromCode(code){
  if (!code) return "âšª";
  if (code.startsWith("jailed_after_")) return "ðŸ”’";
  if (code.startsWith("fled_after_"))   return "âœˆ";
  if (code === "mastermind")            return "ðŸŽ­";
  if (code === "free")                  return "âšª";
  return "â€¢";
}

function renderDirectory(){
  directoryGrid.innerHTML = "";
  directoryPeople.forEach(key=>{
    const person = suspects[key];
    if (!person) return;

    const card = document.createElement("div");
    card.className = "directory-card";

    const initials = person.displayName
      .split(" ")
      .map(w => w[0])
      .join("")
      .slice(0,3);

    const avatar = document.createElement("div");
    avatar.className = "directory-avatar";
    avatar.textContent = initials;

    const main = document.createElement("div");
    main.className = "directory-main";

    const nameEl = document.createElement("div");
    nameEl.className = "directory-name";
    nameEl.textContent = person.displayName;

    const jobEl = document.createElement("div");
    jobEl.className = "directory-job";
    jobEl.textContent = person.job || "";

    const locEl = document.createElement("div");
    locEl.className = "directory-loc";
    locEl.textContent = person.location || "";

    const tagEl = document.createElement("div");
    tagEl.className = "directory-tagline";
    tagEl.textContent = person.tagline || person.arc || "";

    const statusWrap = document.createElement("div");
    statusWrap.className = "directory-status";

    const statusIcon = document.createElement("span");
    statusIcon.textContent = statusIconFromCode(person.status);

    const statusPill = document.createElement("span");
    statusPill.className = "directory-status-pill";
    statusPill.textContent = statusLabelFromCode(person.status);

    statusWrap.appendChild(statusIcon);
    statusWrap.appendChild(statusPill);

    const footerRow = document.createElement("div");
    footerRow.className = "directory-footer-row";

    const btn = document.createElement("button");
    btn.className = "directory-interview";
    btn.textContent = "Interview";
    btn.addEventListener("click", ()=>{
      directoryOverlay.classList.remove("active");
      resetQuestions();
      setCurrentSuspect(key);
    });

    footerRow.appendChild(btn);

    main.appendChild(nameEl);
    if (person.job) main.appendChild(jobEl);
    if (person.location) main.appendChild(locEl);
    if (person.tagline || person.arc) main.appendChild(tagEl);
    main.appendChild(statusWrap);
    main.appendChild(footerRow);

    card.appendChild(avatar);
    card.appendChild(main);
    directoryGrid.appendChild(card);
  });
}

directoryBtn.addEventListener("click", ()=>{
  renderDirectory();
  directoryOverlay.classList.add("active");
});

directoryClose.addEventListener("click", ()=>{
  directoryOverlay.classList.remove("active");
});

/* ====== Brief & Wren hint ====== */

briefBtn.addEventListener("click", ()=>{
  if (caseClosed) return;
  viewMode = "suspect";
  speakerLabel.textContent = "CASE BRIEF";
  if (typingTimer) clearTimeout(typingTimer);
  typingText = currentBrief;
  typingIndex = 0;
  typeStep();
});

copBtn.addEventListener("click", ()=>{
  if (caseClosed) return;
  viewMode = "wren";
  speakerLabel.textContent = "DETECTIVE WREN";
  if (typingTimer) clearTimeout(typingTimer);
  typingText = currentWrenHint;
  typingIndex = 0;
  typeStep();
});

/* ====== Accuse flow ====== */

accuseBtn.addEventListener("click", ()=>{
  if (caseClosed) return;
  if (!anyQuestionAsked) return;
  openAccuseOverlay();
});

function openAccuseOverlay(){
  accuseChoices.innerHTML = "";
  activeSuspects.forEach(key=>{
    const s = suspects[key];
    const b = document.createElement("button");
    b.className = "accuse-btn";
    b.textContent = s.displayName;
    b.addEventListener("click", ()=>resolveAccusation(key));
    accuseChoices.appendChild(b);
  });
  accuseOverlay.classList.add("active");
}

cancelAccuse.addEventListener("click", ()=>{
  accuseOverlay.classList.remove("active");
});

function resolveAccusation(key){
  accuseOverlay.classList.remove("active");
  caseClosed = true;
  accuseBtn.disabled = true;
  nextCaseBtn.style.display = "inline-block";
  resetQuestions();
  questionButtons.forEach(btn=>btn.disabled = true);

  viewMode = "suspect";

  const accused = suspects[key];
  const culprit = suspects[culpritKey];

  if (key === culpritKey){
    speakerLabel.textContent = "CASE CLOSED";
    const templ = currentSuccessEnding || DEFAULT_CASE.successEnding;
    answerEl.textContent = formatEnding(templ, { culprit, accused });
  } else {
    speakerLabel.textContent = "CASE PARTIALLY SOLVED";
    const templ = currentFailureEnding || DEFAULT_CASE.failureEnding;
    answerEl.textContent = formatEnding(templ, { culprit, accused });
  }
}

/* ====== Next case & loader ====== */

nextCaseBtn.addEventListener("click", ()=>{
  currentCaseIndex++;
  if (currentCaseIndex > MAX_CASES){
    currentCaseIndex = 1;
  }
  loadCase(currentCaseIndex);
});

function applyCaseToSuspects(caseData){
  // reset to defaults then override with case-specific answers
  for (const key in suspects){
    suspects[key].currentAnswers = suspects[key].defaultAnswers.slice();
  }
  if (caseData.answers){
    for (const key in caseData.answers){
      if (suspects[key]){
        suspects[key].currentAnswers = caseData.answers[key];
      }
    }
  }
}

/* Decide who is active in this case */
function inferActiveSuspects(caseData){
  // If case explicitly defines suspects, prefer that.
  if (Array.isArray(caseData.suspects) && caseData.suspects.length){
    return caseData.suspects.filter(k => suspects[k]);
  }
  const inferred = new Set();
  if (caseData.culprit && suspects[caseData.culprit]) inferred.add(caseData.culprit);
  if (caseData.answers){
    Object.keys(caseData.answers).forEach(k=>{
      if (suspects[k]) inferred.add(k);
    });
  }
  if (!inferred.size){
    DEFAULT_CASE.suspects.forEach(k=>inferred.add(k));
  }
  return Array.from(inferred);
}

/* Decide who appears in the directory */
function inferDirectory(caseData, active){
  if (Array.isArray(caseData.directory) && caseData.directory.length){
    return caseData.directory.filter(k => suspects[k]);
  }
  // Fallback: same as active suspects for now.
  return active.slice();
}

async function loadCase(index){
  caseClosed = false;
  anyQuestionAsked = false;
  accuseBtn.disabled = true;
  nextCaseBtn.style.display = "none";
  detCanvas.classList.remove("visible");
  resetQuestions();

  const path = `cases/case${index}.json`;
  try{
    const res = await fetch(path);
    if (!res.ok) throw new Error(res.statusText);
    const data = await res.json();

    culpritKey          = data.culprit || DEFAULT_CASE.culprit;
    currentBrief        = data.brief || DEFAULT_CASE.brief;
    currentWrenHint     = data.wrenHint || DEFAULT_CASE.wrenHint;
    currentSuccessEnding = data.successEnding || DEFAULT_CASE.successEnding;
    currentFailureEnding = data.failureEnding || DEFAULT_CASE.failureEnding;

    applyCaseToSuspects(data);
    activeSuspects  = inferActiveSuspects(data);
    directoryPeople = inferDirectory(data, activeSuspects);

    renderSuspectTabs();
    setCurrentSuspect(activeSuspects[0] || "lawson");

    speakerLabel.textContent = `CASE ${data.id || index}`;
    answerEl.textContent = data.title || "New case loaded. Choose a suspect.";

  }catch(err){
    // fallback to default
    culpritKey          = DEFAULT_CASE.culprit;
    currentBrief        = DEFAULT_CASE.brief;
    currentWrenHint     = DEFAULT_CASE.wrenHint;
    currentSuccessEnding = DEFAULT_CASE.successEnding;
    currentFailureEnding = DEFAULT_CASE.failureEnding;

    applyCaseToSuspects(DEFAULT_CASE);
    activeSuspects  = DEFAULT_CASE.suspects.slice();
    directoryPeople = DEFAULT_CASE.directory.slice();

    renderSuspectTabs();
    setCurrentSuspect(activeSuspects[0]);

    speakerLabel.textContent = "CASE LOADER";
    answerEl.textContent =
      `Couldn't load ${path}.\n\nUsing built-in default case instead.`;
  }
}

/* ====== INIT ====== */

(async function init(){
  await loadCharactersMeta();          // pull in roles/status/arc from characters.json
  activeSuspects  = DEFAULT_CASE.suspects.slice();
  directoryPeople = DEFAULT_CASE.directory.slice();
  renderSuspectTabs();
  setCurrentSuspect("lawson");
  loadCase(currentCaseIndex);          // try to load case1.json on start
})();
</script>
</body>
</html>
