<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>Red Baron vs Cowmandos</title>
<style>
  html,body{
    margin:0;
    height:100%;
    overflow:hidden;
    background:#5bd3ff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:#fff;
    touch-action:none;
  }
  canvas{ display:block; touch-action:none; }

  .hud{
    position:fixed; top:8px; left:8px;
    padding:6px 10px;
    background:rgba(0,0,0,.45);
    border-radius:10px;
    font-size:14px;
    pointer-events:none;
    z-index:5;
  }

  .center-msg{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    font-size:18px; text-align:center;
    white-space:pre-line;
    z-index:6;
    padding:16px;
    pointer-events:none; /* enabled only on game-over */
  }
  .center-msg.on{
    pointer-events:auto;
  }

  /* Portrait hint */
  .rotateHint{
    position:fixed; inset:0;
    display:none;
    align-items:center; justify-content:center;
    text-align:center;
    padding:24px;
    z-index:20;
    background:rgba(0,0,0,.45);
    backdrop-filter: blur(3px);
    pointer-events:none;
    font-weight:800;
    letter-spacing:.02em;
  }
  @media (orientation: portrait) and (pointer: coarse){
    .rotateHint{ display:flex; }
  }

  /* ===== Mobile Controls ===== */
  .controls{
    position:fixed;
    left:0; right:0; bottom:0;
    height:42vh;
    max-height:320px;
    pointer-events:none;
    z-index:10;
  }
  .joystick{
    position:absolute;
    left:16px;
    bottom:18px;
    width:150px;
    height:150px;
    border-radius:999px;
    background:rgba(0,0,0,.18);
    border:2px solid rgba(255,255,255,.18);
    backdrop-filter: blur(4px);
    pointer-events:auto;
    touch-action:none;
  }
  .stick{
    position:absolute;
    left:50%; top:50%;
    width:64px; height:64px;
    margin-left:-32px; margin-top:-32px;
    border-radius:999px;
    background:rgba(255,255,255,.18);
    border:2px solid rgba(255,255,255,.25);
  }
  .btns{
    position:absolute;
    right:16px;
    bottom:18px;
    display:flex;
    flex-direction:column;
    gap:14px;
    pointer-events:auto;
  }
  .btn{
    width:150px;
    height:64px;
    border-radius:16px;
    border:2px solid rgba(255,255,255,.22);
    background:rgba(0,0,0,.22);
    color:#fff;
    font-weight:900;
    letter-spacing:.08em;
    text-transform:uppercase;
    font-size:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
    -webkit-user-select:none;
    touch-action:none;
  }
  .btn:active{ transform: translateY(1px); background:rgba(0,0,0,.30); }
  .btn small{
    display:block;
    font-weight:600;
    opacity:.85;
    letter-spacing:0;
    text-transform:none;
    font-size:12px;
    margin-left:8px;
  }

  /* Restart button (appears on game over) */
  .restartWrap{
    position:fixed;
    left:0; right:0;
    bottom: calc(42vh + 12px);
    display:none;
    justify-content:center;
    z-index:15;
    pointer-events:none;
  }
  .restartWrap.show{
    display:flex;
  }
  .restartBtn{
    pointer-events:auto;
    width:min(320px, 82vw);
    height:56px;
    border-radius:18px;
    border:2px solid rgba(255,255,255,.30);
    background:rgba(0,0,0,.28);
    color:#fff;
    font-weight:1000;
    letter-spacing:.10em;
    text-transform:uppercase;
    font-size:16px;
    backdrop-filter: blur(4px);
  }
  .restartBtn:active{ transform: translateY(1px); background:rgba(0,0,0,.36); }

  /* Hide mobile controls on wide desktop */
  @media (pointer:fine) and (min-width: 900px){
    .controls, .restartWrap{ display:none !important; }
    .rotateHint{ display:none !important; }
  }
</style>
</head>
<body>
<canvas id="game"></canvas>
<div class="hud" id="hud"></div>
<div class="center-msg" id="centerMsg"></div>

<div class="rotateHint">Rotate your phone to <b>LANDSCAPE</b> ‚úàÔ∏è</div>

<div class="restartWrap" id="restartWrap">
  <button class="restartBtn" id="btnRestart">Restart</button>
</div>

<div class="controls" id="controls">
  <div class="joystick" id="joy">
    <div class="stick" id="stick"></div>
  </div>
  <div class="btns">
    <div class="btn" id="btnGun">GUN <small>hold</small></div>
    <div class="btn" id="btnBomb">BOMB <small>tap</small></div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  addEventListener("resize", resize); resize();

  // ===== SPRITES =====
  const planeImg      = new Image(); planeImg.src      = "RedBarontriplane-Sheet.gif";
  const blueBombImg   = new Image(); blueBombImg.src   = "BlueBombBetterSpinv4-Sheet.gif";
  const greenBombImg  = new Image(); greenBombImg.src  = "GreenBombBetterSpinv4-Sheet.gif";
  const whiteBombImg  = new Image(); whiteBombImg.src  = "WhiteGreyBombBetterSpinv4-Sheet.gif";
  const cowImg        = new Image(); cowImg.src        = "CowMando.png";

  const assets = [planeImg, blueBombImg, greenBombImg, whiteBombImg, cowImg];
  let loaded = 0;
  assets.forEach(i => i.onload = () => { if(++loaded === assets.length) start(); });

  // ===== SOUND =====
  const snd = {
    engine:    new Audio("sounds/plane_engine_loop.wav"),
    moo:       new Audio("sounds/moo.wav"),
    explosion: new Audio("sounds/explosion.wav")
  };
  snd.engine.loop = true;
  snd.engine.volume = 0.35;
  let engineStarted = false;

  function playSound(audio){
    const a = audio.cloneNode();
    a.volume = audio.volume ?? 1;
    a.play().catch(()=>{});
  }

  // ===== SPRITE META =====
  const sprites = {
    plane:{
      img:planeImg, frames:4,
      get fw(){ return this.img.width/4; },
      get fh(){ return this.img.height; },
      scale:0.065  // ‚úÖ half-size plane (was 0.13)
    },
    cow:{
      img:cowImg, frames:4,
      get fw(){ return this.img.width/4; },
      get fh(){ return this.img.height; },
      scale:1.35
    },
    bossCow:{
      img:cowImg, frames:4,
      get fw(){ return this.img.width/4; },
      get fh(){ return this.img.height; },
      scale:2.2
    },
    blueBomb:{
      img:blueBombImg, frames:2,
      get fw(){ return this.img.width/2; },
      get fh(){ return this.img.height; },
      scale:0.65
    },
    greenRocket:{
      img:greenBombImg, frames:2,
      get fw(){ return this.img.width/2; },
      get fh(){ return this.img.height; },
      scale:0.70
    },
    whiteMissile:{
      img:whiteBombImg, frames:2,
      get fw(){ return this.img.width/2; },
      get fh(){ return this.img.height; },
      scale:0.80
    }
  };

  // ===== Helpers: orientation lock (best-effort) =====
  async function tryLockLandscape(){
    try{
      if (screen.orientation && screen.orientation.lock) {
        await screen.orientation.lock("landscape");
      }
    }catch(e){}
  }

  // ===== INPUT (desktop) =====
  const keys = {};
  addEventListener("keydown", e=>{
    keys[e.key.toLowerCase()] = 1;
    if(!engineStarted && !gameOver){
      snd.engine.currentTime = 0;
      snd.engine.play().catch(()=>{});
      engineStarted = true;
    }
    if(e.key === " "){
      e.preventDefault();
      if(gameOver) reset();
    }
  });
  addEventListener("keyup", e=>{ keys[e.key.toLowerCase()] = 0; });

  // ===== INPUT (mobile) =====
  const controlsEl = document.getElementById("controls");
  const joyEl = document.getElementById("joy");
  const stickEl = document.getElementById("stick");
  const btnGun = document.getElementById("btnGun");
  const btnBomb = document.getElementById("btnBomb");
  const btnRestart = document.getElementById("btnRestart");
  const restartWrap = document.getElementById("restartWrap");
  const centerMsg = document.getElementById("centerMsg");

  let joyActive = false;
  let joyId = null;
  let joyCenter = {x:0,y:0};
  let joyVec = {x:0,y:0};
  const joyRadius = 60;

  let gunHeld = false;
  let bombTap = false;

  function isTouchLayout(){
    return matchMedia("(pointer: coarse), (max-width: 900px)").matches;
  }
  function updateControlsVisibility(){
    controlsEl.style.display = isTouchLayout() ? "block" : "none";
  }
  addEventListener("resize", updateControlsVisibility);
  updateControlsVisibility();

  function startAudioOnFirstTouch(){
    if(engineStarted || gameOver) return;
    snd.engine.currentTime = 0;
    snd.engine.play().catch(()=>{});
    engineStarted = true;
  }

  // Tap anywhere to restart when game over
  canvas.addEventListener("pointerdown", (e)=>{
    if(gameOver){
      reset();
      return;
    }
    // also counts as user gesture for audio + orientation lock
    startAudioOnFirstTouch();
    tryLockLandscape();
  }, {passive:false});

  btnRestart.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    reset();
  }, {passive:false});

  joyEl.addEventListener("pointerdown", (e)=>{
    startAudioOnFirstTouch();
    tryLockLandscape();
    joyActive = true;
    joyId = e.pointerId;
    joyEl.setPointerCapture(joyId);
    const r = joyEl.getBoundingClientRect();
    joyCenter.x = r.left + r.width/2;
    joyCenter.y = r.top + r.height/2;
    setJoyFromPointer(e.clientX, e.clientY);
  });

  joyEl.addEventListener("pointermove", (e)=>{
    if(!joyActive || e.pointerId !== joyId) return;
    setJoyFromPointer(e.clientX, e.clientY);
  });

  joyEl.addEventListener("pointerup", (e)=>{
    if(e.pointerId !== joyId) return;
    joyActive = false;
    joyId = null;
    joyVec.x = 0; joyVec.y = 0;
    stickEl.style.transform = "translate(0px,0px)";
  });

  joyEl.addEventListener("pointercancel", ()=>{
    joyActive = false;
    joyId = null;
    joyVec.x = 0; joyVec.y = 0;
    stickEl.style.transform = "translate(0px,0px)";
  });

  function setJoyFromPointer(px,py){
    const dx = px - joyCenter.x;
    const dy = py - joyCenter.y;
    const dist = Math.hypot(dx,dy);
    const clamped = Math.min(dist, joyRadius);
    const nx = dist ? dx/dist : 0;
    const ny = dist ? dy/dist : 0;
    const sx = nx * clamped;
    const sy = ny * clamped;
    stickEl.style.transform = `translate(${sx}px,${sy}px)`;
    joyVec.x = (sx / joyRadius);
    joyVec.y = (sy / joyRadius);
  }

  btnGun.addEventListener("pointerdown", ()=>{
    startAudioOnFirstTouch();
    tryLockLandscape();
    gunHeld = true;
  });
  btnGun.addEventListener("pointerup", ()=>{ gunHeld = false; });
  btnGun.addEventListener("pointerleave", ()=>{ gunHeld = false; });
  btnGun.addEventListener("pointercancel", ()=>{ gunHeld = false; });

  btnBomb.addEventListener("pointerdown", ()=>{
    startAudioOnFirstTouch();
    tryLockLandscape();
    bombTap = true;
  });

  // ===== GAME STATE =====
  let last = 0;
  let gameOver = false;
  let score = 0;
  let lives = 3;

  const plane = {
    x:0,y:0,vx:0,vy:0,
    speed:300,
    facing:1,
    frame:0, ft:0,
    bombCD:0.22, bt:0,
    gunCD:0.10, gunTimer:0,
    clipSize:3,
    clip:3,
    reloadDelay:1.0,
    reload:0
  };

  const cows = [];
  const bombs = [];
  const rockets = [];
  const bullets = [];
  const bossMissiles = [];
  const muzzleFlashes = [];
  const explosions = [];

  let cowTimer = 1;
  let cowRate  = 2.4;

  let boss = null;
  let bossAppeared = false;

  const clouds = [];
  function makeCloud(){
    return {
      x:Math.random()*canvas.width,
      y:Math.random()*canvas.height*0.6,
      w:80+Math.random()*140,
      h:30+Math.random()*35,
      speed:20+Math.random()*25,
      depth:Math.random()<0.5?0.5:1
    };
  }
  for(let i=0;i<10;i++) clouds.push(makeCloud());

  function start(){
    reset();
    requestAnimationFrame(loop);
  }

  function reset(){
    gameOver = false;
    score = 0;
    lives = 3;
    cows.length = bombs.length = rockets.length =
      bullets.length = bossMissiles.length =
      muzzleFlashes.length = explosions.length = 0;

    cowTimer = 1;
    cowRate  = 2.4;
    boss = null;
    bossAppeared = false;

    const p = sprites.plane;
    const w = p.fw*p.scale;
    const h = p.fh*p.scale;
    plane.x = canvas.width*0.2 - w/2;
    plane.y = canvas.height*0.35 - h/2;
    plane.bt = 0;
    plane.gunTimer = 0;
    plane.facing = 1;
    plane.clip = plane.clipSize;
    plane.reload = 0;

    // hide restart UI
    restartWrap.classList.remove("show");
    centerMsg.classList.remove("on");

    document.getElementById("centerMsg").textContent =
      isTouchLayout()
        ? "Drag stick to fly (LANDSCAPE recommended)\nHold GUN / Tap BOMB\nAvoid rockets + homing missiles!"
        : "WASD/Arrows = fly\nSPACE = bombs (3-shot clip)\nJ/F/K = gun\nAvoid rockets + homing missiles!";
  }

  function spawnCow(){
    const c = sprites.cow;
    const w = c.fw*c.scale;
    const h = c.fh*c.scale;
    const fromLeft = Math.random() < 0.5;
    const dir = fromLeft ? 1 : -1;
    const x = fromLeft ? -w : canvas.width + w;
    const y = canvas.height - h - 14;

    cows.push({
      x,y,dir,
      speed: 55 + Math.random()*45,
      ft:0, frame:0,
      shoot:1 + Math.random()*1.4,
      hp:1,
      upgraded:false
    });
  }

  function spawnBossCow(){
    const s = sprites.bossCow;
    const w = s.fw*s.scale;
    const h = s.fh*s.scale;
    boss = {
      x:canvas.width + w,
      y:canvas.height - h - 30,
      dir:-1,
      speed:25,
      ft:0, frame:0,
      fire:0.9,
      hp:10,
      upgraded:false
    };
    playSound(snd.moo);
  }

  function addExplosion(x,y,scale=1){
    explosions.push({ x,y, t:0, ttl:0.55, maxR:40*scale });
  }

  function dropBomb(){
    const p = sprites.plane;
    const w = p.fw*p.scale;
    const h = p.fh*p.scale;
    const b = sprites.blueBomb;
    const bw = b.fw*b.scale;
    const front = (plane.facing===1?0.7:0.3);
    bombs.push({
      x:plane.x + w*front - bw/2,
      y:plane.y + h*0.3,
      vy:260,
      ft:0, f:0
    });
  }

  function fireBullet(){
    const p = sprites.plane;
    const w = p.fw*p.scale;
    const h = p.fh*p.scale;
    const noseX = plane.facing === 1 ? plane.x + w * 0.9 : plane.x + w * 0.1;
    const noseY = plane.y + h * 0.45;
    bullets.push({ x:noseX, y:noseY, vx: plane.facing * 550, radius: 4 });
    muzzleFlashes.push({ x:noseX, y:noseY, t:0, ttl:0.08 });
  }

  function fireRocketFrom(x,y){ rockets.push({ x, y, vy:-260, ft:0, f:0 }); }
  function fireBossMissileFrom(x,y){ bossMissiles.push({ x, y, vy:-260, ft:0, f:0 }); }

  function overlap(ax,ay,aw,ah,bx,by,bw,bh){
    return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
  }

  function endGame(){
    gameOver = true;
    snd.engine.pause();
    engineStarted = false;

    // show restart UI on mobile
    restartWrap.classList.add("show");
    centerMsg.classList.add("on");

    document.getElementById("centerMsg").textContent =
      `YOU WERE MILKED BY THE COWMANDOS üí•\nScore: ${score}\nTap RESTART (or tap screen)`;
  }

  // ===== UPDATE =====
  function update(dt){
    if(gameOver) return;

    if(!bossAppeared && score >= 800){
      bossAppeared = true;
      spawnBossCow();
    }

    const usingTouch = isTouchLayout();
    let inputX = 0, inputY = 0;

    if(usingTouch){
      inputX = joyVec.x;
      inputY = joyVec.y;
    }else{
      inputX = (keys["a"]||keys["arrowleft"]?-1:0) + (keys["d"]||keys["arrowright"]?1:0);
      inputY = (keys["w"]||keys["arrowup"]?-1:0) + (keys["s"]||keys["arrowdown"]?1:0);
      const mag = Math.hypot(inputX,inputY);
      if(mag>1){ inputX/=mag; inputY/=mag; }
    }

    plane.vx = inputX * plane.speed;
    plane.vy = inputY * plane.speed;

    if(plane.vx < -10) plane.facing = -1;
    else if(plane.vx > 10) plane.facing = 1;

    plane.x += plane.vx*dt;
    plane.y += plane.vy*dt;

    const p = sprites.plane;
    const pw = p.fw*p.scale;
    const ph = p.fh*p.scale;

    const groundY = canvas.height * 0.88;
    const maxY = groundY - ph; // cannot dip into grass
    plane.x = Math.max(0, Math.min(canvas.width-pw, plane.x));
    plane.y = Math.max(0, Math.min(maxY, plane.y));

    plane.ft += dt;
    if(plane.ft > 0.10){
      plane.ft = 0;
      plane.frame = (plane.frame+1)%p.frames;
    }

    // bomb reload
    if(plane.reload > 0){
      plane.reload -= dt;
      if(plane.reload <= 0 && plane.clip === 0) plane.clip = plane.clipSize;
    }

    // bombs: SPACE or tap
    plane.bt -= dt;
    const bombPressed = (keys[" "]||keys["space"]) || bombTap;
    if(bombPressed && plane.bt<=0 && plane.clip>0 && plane.reload<=0){
      dropBomb();
      plane.bt = plane.bombCD;
      plane.clip--;
      if(plane.clip === 0) plane.reload = plane.reloadDelay;
    }
    bombTap = false;

    // gun: J/F/K or hold
    plane.gunTimer -= dt;
    const gunPressed = keys["j"] || keys["f"] || keys["k"] || gunHeld;
    if(gunPressed && plane.gunTimer <= 0){
      fireBullet();
      plane.gunTimer = plane.gunCD;
    }

    // bombs update
    for(let i=bombs.length-1;i>=0;i--){
      const b = bombs[i];
      b.y += b.vy*dt;
      b.ft += dt;
      if(b.ft>0.08){ b.ft=0; b.f=(b.f+1)%sprites.blueBomb.frames; }
      if(b.y > canvas.height+50) bombs.splice(i,1);
    }

    // bullets update
    for(let i=bullets.length-1;i>=0;i--){
      const bl = bullets[i];
      bl.x += bl.vx*dt;
      if(bl.x < -40 || bl.x > canvas.width+40) bullets.splice(i,1);
    }

    // muzzle flashes
    for(let i=muzzleFlashes.length-1;i>=0;i--){
      const m = muzzleFlashes[i];
      m.t += dt;
      if(m.t > m.ttl) muzzleFlashes.splice(i,1);
    }

    // spawn cows
    cowTimer -= dt;
    if(cowTimer<=0){
      spawnCow();
      cowRate = Math.max(1.1, cowRate*0.97);
      cowTimer = cowRate;
    }

    // cows update
    for(let i=cows.length-1;i>=0;i--){
      const c = cows[i];
      const cw = sprites.cow.fw*sprites.cow.scale;
      c.x += c.speed * dt * c.dir;

      c.ft += dt;
      if(c.ft>0.13){ c.ft=0; c.frame=(c.frame+1)%sprites.cow.frames; }

      c.shoot -= dt;
      if(c.shoot<=0){
        const frontX = c.dir < 0 ? c.x + cw*0.25 : c.x + cw*0.75;
        fireRocketFrom(frontX, c.y);
        c.shoot = 1 + Math.random()*1.3;
      }

      // crossing upgrade
      if(c.dir < 0 && c.x < -cw){
        if(!c.upgraded){
          c.upgraded = true;
          c.hp = 2;
          c.speed *= 1.15;
          c.dir = 1;
          c.x = -cw + 10;
        }else cows.splice(i,1);
      }else if(c.dir > 0 && c.x > canvas.width + cw){
        if(!c.upgraded){
          c.upgraded = true;
          c.hp = 2;
          c.speed *= 1.15;
          c.dir = -1;
          c.x = canvas.width + cw - 10;
        }else cows.splice(i,1);
      }
    }

    // boss
    if(boss){
      const s = sprites.bossCow;
      const bw = s.fw*s.scale;
      boss.x += boss.speed * dt * boss.dir;

      boss.ft += dt;
      if(boss.ft>0.12){ boss.ft=0; boss.frame=(boss.frame+1)%s.frames; }

      boss.fire -= dt;
      if(boss.fire<=0){
        fireBossMissileFrom(boss.x + bw*0.3, boss.y + 10);
        fireBossMissileFrom(boss.x + bw*0.7, boss.y + 10);
        boss.fire = 0.9;
      }
    }

    // green rockets
    for(let i=rockets.length-1;i>=0;i--){
      const r = rockets[i];
      r.y += r.vy*dt;
      r.ft += dt;
      if(r.ft>0.08){ r.ft=0; r.f=(r.f+1)%sprites.greenRocket.frames; }
      if(r.y < -80) rockets.splice(i,1);
    }

    // white boss missiles (homing)
    for(let i=bossMissiles.length-1;i>=0;i--){
      const m = bossMissiles[i];
      m.y += m.vy*dt;

      const planeCenterX = plane.x + pw/2;
      const dx = planeCenterX - m.x;
      const maxStep = 260 * dt;
      let step = dx * 0.8 * dt;
      if(step > maxStep) step = maxStep;
      if(step < -maxStep) step = -maxStep;
      m.x += step;

      m.ft += dt;
      if(m.ft>0.08){ m.ft=0; m.f=(m.f+1)%sprites.whiteMissile.frames; }
      if(m.y < -80) bossMissiles.splice(i,1);
    }

    // collisions: (kept same as your current version)
    // -- bombs vs cows/boss
    for(let i=bombs.length-1;i>=0;i--){
      const b = bombs[i];
      const bw2 = sprites.blueBomb.fw*sprites.blueBomb.scale;
      const bh2 = sprites.blueBomb.fh*sprites.blueBomb.scale;
      const bx = b.x, by = b.y;
      let hit = false;

      for(let j=cows.length-1;j>=0;j--){
        const c = cows[j];
        const cw = sprites.cow.fw*sprites.cow.scale;
        const ch = sprites.cow.fh*sprites.cow.scale;
        if(overlap(bx,by,bw2,bh2,c.x,c.y,cw,ch)){
          addExplosion(c.x+cw/2, c.y+ch/2, 0.9);
          playSound(snd.moo); playSound(snd.explosion);
          c.hp -= 2;
          if(c.hp<=0){ cows.splice(j,1); score += c.upgraded ? 250 : 150; }
          else score += 80;
          hit = true; break;
        }
      }

      if(!hit && boss){
        const s = sprites.bossCow;
        const cw = s.fw*s.scale;
        const ch = s.fh*s.scale;
        if(overlap(bx,by,bw2,bh2,boss.x,boss.y,cw,ch)){
          addExplosion(boss.x+cw/2, boss.y+ch/2, 1.2);
          playSound(snd.moo);
          boss.hp -= 2;
          score += 100;
          hit = true;
          if(boss.hp<=0){
            addExplosion(boss.x+cw/2, boss.y+ch/2, 2.2);
            playSound(snd.explosion);
            score += 1200;
            boss = null;
          }
        }
      }

      if(hit) bombs.splice(i,1);
    }

    // bullets vs cows/boss
    for(let i=bullets.length-1;i>=0;i--){
      const bl = bullets[i];
      const br = bl.radius;
      const bx = bl.x - br;
      const by = bl.y - br;
      const bw2 = br*2;
      const bh2 = br*2;
      let hit = false;

      for(let j=cows.length-1;j>=0;j--){
        const c = cows[j];
        const cw = sprites.cow.fw*sprites.cow.scale;
        const ch = sprites.cow.fh*sprites.cow.scale;
        if(overlap(bx,by,bw2,bh2,c.x,c.y,cw,ch)){
          addExplosion(bl.x, bl.y, 0.4);
          c.hp -= 1;
          score += 40;
          if(c.hp<=0){ playSound(snd.moo); playSound(snd.explosion); cows.splice(j,1); score += c.upgraded ? 200 : 120; }
          hit = true; break;
        }
      }

      if(!hit && boss){
        const s = sprites.bossCow;
        const cw = s.fw*s.scale;
        const ch = s.fh*s.scale;
        if(overlap(bx,by,bw2,bh2,boss.x,boss.y,cw,ch)){
          addExplosion(bl.x, bl.y, 0.6);
          boss.hp -= 1;
          score += 60;
          hit = true;
          if(boss.hp<=0){
            addExplosion(boss.x+cw/2, boss.y+ch/2, 2.2);
            playSound(snd.explosion);
            score += 1300;
            boss = null;
          }
        }
      }

      if(hit) bullets.splice(i,1);
    }

    const pRect = { x:plane.x, y:plane.y, w:pw*0.7, h:ph*0.5 };

    // rockets vs plane
    for(let i=rockets.length-1;i>=0;i--){
      const r = rockets[i];
      const rw = sprites.greenRocket.fw*sprites.greenRocket.scale;
      const rh = sprites.greenRocket.fh*sprites.greenRocket.scale;
      if(overlap(pRect.x,pRect.y,pRect.w,pRect.h,r.x-rw/2,r.y,rw,rh)){
        rockets.splice(i,1);
        addExplosion(plane.x+pw/2, plane.y+ph/2, 1.2);
        playSound(snd.explosion);
        if(--lives<=0) endGame();
      }
    }

    // boss missiles vs plane
    for(let i=bossMissiles.length-1;i>=0;i--){
      const m = bossMissiles[i];
      const mw = sprites.whiteMissile.fw*sprites.whiteMissile.scale;
      const mh = sprites.whiteMissile.fh*sprites.whiteMissile.scale;
      if(overlap(pRect.x,pRect.y,pRect.w,pRect.h,m.x-mw/2,m.y,mw,mh)){
        bossMissiles.splice(i,1);
        addExplosion(plane.x+pw/2, plane.y+ph/2, 1.4);
        playSound(snd.explosion);
        if(--lives<=0) endGame();
      }
    }

    // explosions lifetime
    for(let i=explosions.length-1;i>=0;i--){
      const e = explosions[i];
      e.t += dt;
      if(e.t>e.ttl) explosions.splice(i,1);
    }

    document.getElementById("hud").textContent =
      `Score: ${score}  Lives: ${lives}  Bombs: ${plane.clip}/${plane.clipSize}`;
    if(!gameOver) document.getElementById("centerMsg").textContent = "";
  }

  function drawSprite(sprite, frame, x, y, flipX=false, rotate180=false){
    const fw = sprite.fw, fh = sprite.fh, scale = sprite.scale;
    const dw = fw*scale, dh = fh*scale;
    const sx = frame*fw;

    if(rotate180){
      ctx.save();
      ctx.translate(x+dw/2, y+dh/2);
      ctx.rotate(Math.PI);
      ctx.drawImage(sprite.img, sx, 0, fw, fh, -dw/2, -dh/2, dw, dh);
      ctx.restore();
    }else if(flipX){
      ctx.save();
      ctx.translate(x+dw, y);
      ctx.scale(-1,1);
      ctx.drawImage(sprite.img, sx, 0, fw, fh, 0, 0, dw, dh);
      ctx.restore();
    }else{
      ctx.drawImage(sprite.img, sx, 0, fw, fh, x, y, dw, dh);
    }
  }

  function render(){
    ctx.fillStyle = "#5bd3ff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    clouds.forEach(c=>{
      c.x -= c.speed*c.depth*0.016;
      if(c.x < -c.w){ Object.assign(c, makeCloud(), { x:canvas.width }); }
      ctx.fillStyle = c.depth===1 ? "#9be9ff" : "#baf3ff";
      ctx.fillRect(c.x,c.y,c.w,c.h);
    });

    const groundY = canvas.height*0.88;
    ctx.fillStyle = "#62d255";
    ctx.fillRect(0, groundY, canvas.width, canvas.height-groundY);

    // plane
    const p = sprites.plane;
    const pw = p.fw*p.scale;
    const ph = p.fh*p.scale;
    drawSprite(sprites.plane, plane.frame, plane.x, plane.y, plane.facing===-1, false);

    // lock-on reticle
    if(bossMissiles.length > 0){
      const cx = plane.x + pw/2;
      const cy = plane.y + ph*0.4;
      ctx.save();
      ctx.strokeStyle = "#ff3355";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(cx, cy, 30, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    // cows
    cows.forEach(c=>{
      const flip = c.dir > 0;
      drawSprite(sprites.cow, c.frame, c.x, c.y, flip, false);
    });

    // boss
    if(boss){
      const bossFlip = boss.dir > 0;
      drawSprite(sprites.bossCow, boss.frame, boss.x, boss.y, bossFlip, false);
    }

    bombs.forEach(b=> drawSprite(sprites.blueBomb, b.f, b.x, b.y));
    rockets.forEach(r=> drawSprite(sprites.greenRocket, r.f, r.x, r.y, false, true));
    bossMissiles.forEach(m=> drawSprite(sprites.whiteMissile, m.f, m.x, m.y, false, true));

    // bullets
    ctx.fillStyle = "#fffb";
    bullets.forEach(bl=>{
      ctx.beginPath();
      ctx.arc(bl.x, bl.y, bl.radius, 0, Math.PI*2);
      ctx.fill();
    });

    // muzzle flashes
    muzzleFlashes.forEach(m=>{
      const t = m.t / m.ttl;
      const alpha = 1 - t;
      const size = 10 * (1 - t);
      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.fillStyle = "#ffd966";
      ctx.beginPath();
      ctx.arc(m.x, m.y, size, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    });

    // explosions
    explosions.forEach(e=>{
      const t = e.t / e.ttl;
      const r = e.maxR * t;
      const alpha = 1 - t;
      ctx.save();
      ctx.globalAlpha = alpha;
      const grad = ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,r);
      grad.addColorStop(0,"rgba(255,255,255,1)");
      grad.addColorStop(0.3,"rgba(255,200,120,1)");
      grad.addColorStop(1,"rgba(0,0,0,0)");
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(e.x,e.y,r,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
    });
  }

  function loop(t){
    if(!last) last = t;
    const dt = (t-last)/1000;
    last = t;
    update(dt);
    render();
    requestAnimationFrame(loop);
  }
})();
</script>
</body>
</html>
